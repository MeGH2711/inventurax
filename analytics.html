<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inventurax | Analytics</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/lightTheme.css">
    <link rel="stylesheet" href="css/material-font-icons.css">
</head>

<body>

    <div class="d-flex" id="wrapper">

        <!-- Sidebar -->
        <div class="shadow-sm" id="sidebar-wrapper">
            <div class="sidebar-heading p-3 d-flex justify-content-between align-items-center">
                <img id="sidebarLogoFull" src="images/inventuraxLogoWhite.png" alt="Full Logo" class="img-fluid">
                <img id="sidebarLogoIcon" src="images/inventuraxIconWhite.png" alt="Icon Logo" class="img-fluid d-none">
            </div>

            <!-- Scrollable content wrapper -->
            <div class="sidebar-content">
                <div class="list-group list-group-flush flex-grow-1">
                    <a href="/dashboard" class="list-group-item list-group-item-sidebar" title="Dashboard">
                        <i class="gsymbols-round gicon-home fs-5"></i><span class="link-text">Dashboard</span>
                    </a>
                    <a href="/productlisting" class="list-group-item list-group-item-sidebar" title="Product Listing">
                        <i class="gsymbols-round gicon-inventory fs-5"></i><span class="link-text">Product
                            Listing</span>
                    </a>
                    <a href="/billing" class="list-group-item list-group-item-sidebar" title="Billing">
                        <i class="gsymbols-round gicon-receipt_long fs-5"></i><span class="link-text">Billing</span>
                    </a>
                    <a href="/billlogs" class="list-group-item list-group-item-sidebar" title="Bill Logs">
                        <i class="gsymbols-round gicon-auto_stories fs-5"></i><span class="link-text">Bill Logs</span>
                    </a>
                    <a class="list-group-item list-group-item-sidebar active" title="Analytics">
                        <i class="gsymbols-round gicon-insights fs-5"></i><span class="link-text">Analytics</span>
                    </a>
                    <a href="/customers" class="list-group-item list-group-item-sidebar" title="Customers">
                        <i class="gsymbols-round gicon-group fs-5"></i><span class="link-text">Customers</span>
                    </a>
                </div>
            </div>

            <!-- Bottom Toggle Button -->
            <div class="text-center p-3 sidebar-toggle-wrapper">
                <button class="btn btn-outline-light w-100" id="toggleSidebar">
                    <i class="gsymbols-round gicon-chevron_left" id="toggleIcon"></i>
                </button>
            </div>
        </div>

        <!-- Main Page content -->
        <div id="mainPageContent" class="p-4 flex-grow-1">

            <!-- Header Section -->
            <div class="container-fluid d-flex justify-content-end">
                <div class="dropdown profileButton">
                    <button class="btn btn-sm btn-darkblue dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        Username
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item dropdown-item-signout" href="/logout">Sign Out</a></li>
                    </ul>
                </div>
            </div>

            <div class="container-fluid my-4">
                <div class="card shadow-sm mb-4 border-0 rounded-3 overflow-hidden analyticsCard">
                    <div class="card-header py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex align-items-center">
                                <i class="gsymbols-round gicon-bar_chart fs-3 me-2"></i>
                                <span class="fw-semibold fs-5">Sales Overview</span>
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-row">

                                <!-- Sales Group Picker -->
                                <select id="salesGrouping" class="form-select form-select-sm w-auto ms-2">
                                    <option value="daily" selected>Daily</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>

                                <!-- Date Range Picker -->
                                <div class="input-group input-group-sm">
                                    <input type="date" id="salesStartDate" class="form-control form-control-sm">
                                    <span class="input-group-text">to</span>
                                    <input type="date" id="salesEndDate" class="form-control form-control-sm">
                                    <button class="btn btn-sm btn-darkblue" id="salesApplyDateFilter">Apply</button>
                                </div>

                                <!-- Chart/Table Toggle -->
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-light active" type="button" id="salesChartViewBtn"
                                        title="Chart View">
                                        <i class="gsymbols-round gicon-bar_chart"></i>
                                    </button>
                                    <button class="btn btn-outline-light" type="button" id="salesTableViewBtn"
                                        title="Table View">
                                        <i class="gsymbols-round gicon-table"></i>
                                    </button>
                                </div>

                                <!-- Expand Button -->
                                <div>
                                    <button class="btn btn-sm btn-light" id="expandSalesCardBtn">
                                        <i class="gsymbols-round gicon-open_in_full"></i>
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="card-body bg-light-subtle p-0" style="height: 400px; overflow: hidden;">
                        <div id="salesChartContainer" class="h-100 overflow-auto p-3">
                            <canvas id="salesBarChart" style="width: 100%; height: 300px;"></canvas>
                        </div>
                        <div id="salesTableContainer" class="d-none h-100 overflow-auto p-3">
                            <div class="card border-1 roundedTableCard">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered align-middle text-center roundedTable"
                                        id="salesTable">
                                        <thead>
                                            <tr>
                                                <th class="text-center">Sr. No.</th>
                                                <th class="text-center">Date</th>
                                                <th class="text-center">Total Sales (₹)</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td class="text-center bg-transparent fw-bold" colspan="2">Total Sales
                                                    </th>
                                                <td class="text-center bg-transparent fw-bold" id="totalSalesCell">₹
                                                    0.00</th>
                                            </tr>
                                            <tr>
                                                <td class="text-center bg-transparent fw-bold" colspan="2">Average
                                                    Amount</th>
                                                <td class="text-center bg-transparent fw-bold" id="averageSalesCell">₹
                                                    0.00</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Section -->
            <footer class="mt-auto pt-3 border-top text-center small text-muted">
                <div class="container">
                    &copy; 2025 Inventurax. All rights reserved. | Version 1.0.0
                </div>
            </footer>

        </div>
    </div>

    <!-- Modal -->

    <!-- Fullscreen Modal for Sales Overview -->
    <div class="modal fade" id="salesFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-bar_chart fs-3 me-2"></i>Sales Overview
                        (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center flex-row gap-2 mb-3">
                            <!-- Controls -->
                            <div class="d-flex align-items-center gap-2 flex-row">
                                <select id="modalSalesGrouping" class="form-select form-select-sm w-auto">
                                    <option value="daily">Daily</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="modalSalesStartDate" class="form-control">
                                    <span class="input-group-text">to</span>
                                    <input type="date" id="modalSalesEndDate" class="form-control">
                                    <button class="btn btn-sm btn-darkblue"
                                        id="modalSalesApplyDateFilter">Apply</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-darkblue active" id="modalSalesChartViewBtn"><i
                                            class="gsymbols-round gicon-bar_chart"></i></button>
                                    <button class="btn btn-outline-darkblue" id="modalSalesTableViewBtn"><i
                                            class="gsymbols-round gicon-table"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Chart/Table Containers -->
                        <div class="p-2" style="height: 80vh;">
                            <div id="modalSalesChartContainer" class="h-100 overflow-auto p-2">
                                <canvas id="modalSalesBarChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                            <div id="modalSalesTableContainer" class="d-none h-100 overflow-auto p-2">
                                <div class="card roundedTableCard">
                                    <table class="table table-sm table-bordered text-center roundedTable"
                                        id="modalSalesTable">
                                        <thead>
                                            <tr>
                                                <th>Sr. No.</th>
                                                <th>Date</th>
                                                <th>Total Sales (₹)</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="2">Total Sales</td>
                                                <td id="modalTotalSalesCell">₹ 0.00</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">Average</td>
                                                <td id="modalAverageSalesCell">₹ 0.00</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="mainToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="mainToastBody">
                    <!-- Message goes here -->
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/chart.umd.js"></script>

    <script>
        // Session check
        fetch('/session-check')
            .then(res => res.json())
            .then(data => {
                if (!data.loggedIn) {
                    window.location.href = '/';
                } else {
                    document.querySelector('.profileButton .dropdown-toggle').textContent = data.username;
                }
            })
            .catch(() => {
                window.location.href = '/';
            });

        $(document).ready(function () {
            fetch('/get-bills')
                .then(res => res.json())
                .then(data => {

                    allBills = data;

                    const dates = allBills.map(bill => bill.billingDate.split('T')[0]);
                    dates.sort();

                    const minDate = dates[0];
                    const maxDate = dates[dates.length - 1];

                    $('#salesStartDate').val(minDate);
                    $('#salesEndDate').val(maxDate);

                    renderSales(allBills);
                });

            $('#salesApplyDateFilter').on('click', function () {
                const start = $('#salesStartDate').val();
                const end = $('#salesEndDate').val();

                if (!start || !end) {
                    showToast('Please select both start and end dates.', 'text-bg-warning');
                    return;
                }

                currentStartDate = start;
                currentEndDate = end;

                $('#modalSalesStartDate').val(currentStartDate);
                $('#modalSalesEndDate').val(currentEndDate);

                const filtered = allBills.filter(bill => {
                    const billDate = bill.billingDate.split('T')[0];
                    return billDate >= start && billDate <= end;
                });

                renderSales(filtered);

                if ($('#salesFullscreenModal').hasClass('show')) {
                    renderModalSales(filtered);
                }
            });

        });

        // Toggle functionality
        $('#salesChartViewBtn').on('click', function () {
            currentViewMode = 'chart';
            $('#salesChartContainer').removeClass('d-none');
            $('#salesTableContainer').addClass('d-none');
            $('#salesChartViewBtn').addClass('active');
            $('#salesTableViewBtn').removeClass('active');

            syncModalViewWithMain();
        });

        $('#salesTableViewBtn').on('click', function () {
            currentViewMode = 'table';
            $('#salesChartContainer').addClass('d-none');
            $('#salesTableContainer').removeClass('d-none');
            $('#salesChartViewBtn').removeClass('active');
            $('#salesTableViewBtn').addClass('active');

            syncModalViewWithMain();
        });

        $('#salesGrouping').on('change', function () {
            $('#modalSalesGrouping').val(this.value);
            $('#salesApplyDateFilter').click();
        });

        let allBills = [];

        function renderSales(filteredData) {
            const grouping = $('#salesGrouping').val();
            const salesGrouped = {};

            const formatDisplayDate = (isoDate, mode) => {
                const date = new Date(isoDate);
                if (isNaN(date)) return 'Invalid Date';
                const year = date.getFullYear();
                const month = date.toLocaleString('en-US', { month: 'short' });
                const day = String(date.getDate()).padStart(2, '0');
                const weekday = date.toLocaleString('en-US', { weekday: 'short' });

                if (mode === 'yearly') return `${year}`;
                if (mode === 'monthly') return `${month}/${year}`;
                return `${day}/${month}/${year}, ${weekday}`;
            };

            filteredData.forEach(bill => {
                const dateObj = new Date(bill.billingDate);
                let key;

                switch (grouping) {
                    case 'yearly':
                        key = `${dateObj.getFullYear()}`;
                        break;
                    case 'monthly':
                        key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        break;
                    default:
                        key = bill.billingDate.split('T')[0]; // daily
                }

                salesGrouped[key] = (salesGrouped[key] || 0) + bill.finalTotal;
            });

            const sortedKeys = Object.keys(salesGrouped).sort();
            const tbody = $('#salesTable tbody');
            tbody.empty();

            let total = 0;
            sortedKeys.forEach((key, i) => {
                const value = salesGrouped[key];
                total += value;

                const displayDate = formatDisplayDate(
                    grouping === 'daily' ? key : key + '-01',
                    grouping
                );

                const row = `
                    <tr>
                        <td class="text-center">${i + 1}</td>
                        <td class="text-center">${displayDate}</td>
                        <td class="text-center">${value.toFixed(2)}</td>
                    </tr>
                `;
                tbody.append(row);
            });

            const average = total / sortedKeys.length || 0;
            $('#totalSalesCell').text(`₹ ${total.toFixed(2)}`);
            $('#averageSalesCell').text(`₹ ${average.toFixed(2)}`);

            const labels = sortedKeys.map(k =>
                formatDisplayDate(grouping === 'daily' ? k : k + '-01', grouping)
            );

            const sales = sortedKeys.map(k => salesGrouped[k]);

            const ctx = document.getElementById('salesBarChart').getContext('2d');
            if (window.salesChart) window.salesChart.destroy();

            window.salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Total Sales',
                            data: sales,
                            backgroundColor: 'rgba(10, 47, 79, 0.8)',
                            borderColor: 'rgba(10, 47, 79)',
                            borderWidth: 1
                        },
                        {
                            label: 'Average',
                            data: new Array(sales.length).fill(average),
                            type: 'line',
                            borderColor: 'rgba(10, 47, 79)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 1.5,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function (ctx) {
                                    const label = ctx.dataset.label;
                                    return label === 'Average'
                                        ? ` Average: ₹ ${ctx.raw.toFixed(2)}`
                                        : ` Total Sales: ₹ ${ctx.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        let modalSalesChart;

        let currentViewMode = 'chart';

        let currentStartDate = '';
        let currentEndDate = '';

        $('#expandSalesCardBtn').on('click', function () {
            // Sync dates
            $('#modalSalesStartDate').val(currentStartDate || $('#salesStartDate').val());
            $('#modalSalesEndDate').val(currentEndDate || $('#salesEndDate').val());

            // Sync grouping
            $('#modalSalesGrouping').val($('#salesGrouping').val());

            // Filter and render both
            const filtered = allBills.filter(bill => {
                const billDate = bill.billingDate.split('T')[0];
                return billDate >= $('#modalSalesStartDate').val() &&
                    billDate <= $('#modalSalesEndDate').val();
            });

            renderModalSales(filtered);
            syncModalViewWithMain();

            const modal = new bootstrap.Modal(document.getElementById('salesFullscreenModal'));
            modal.show();

            setTimeout(() => {
                if (modalSalesChart) modalSalesChart.resize();
            }, 500);
        });

        // Modal event handlers
        $('#modalSalesApplyDateFilter').on('click', function () {
            const start = $('#modalSalesStartDate').val();
            const end = $('#modalSalesEndDate').val();

            if (!start || !end) {
                showToast('Please select both start and end dates.', 'text-bg-warning');
                return;
            }

            currentStartDate = start;
            currentEndDate = end;

            // Apply to main card
            $('#salesStartDate').val(currentStartDate);
            $('#salesEndDate').val(currentEndDate);

            const filtered = allBills.filter(bill => {
                const billDate = bill.billingDate.split('T')[0];
                return billDate >= start && billDate <= end;
            });

            renderModalSales(filtered);
            renderSales(filtered);
        });

        $('#modalSalesGrouping').on('change', function () {
            $('#salesGrouping').val(this.value);
            $('#modalSalesApplyDateFilter').click();
        });

        $('#modalSalesChartViewBtn').on('click', function () {
            currentViewMode = 'chart';
            $('#modalSalesChartContainer').removeClass('d-none');
            $('#modalSalesTableContainer').addClass('d-none');
            $('#modalSalesChartViewBtn').addClass('active');
            $('#modalSalesTableViewBtn').removeClass('active');

            // Sync main card view
            syncMainViewWithModal();
        });

        $('#modalSalesTableViewBtn').on('click', function () {
            currentViewMode = 'table';
            $('#modalSalesChartContainer').addClass('d-none');
            $('#modalSalesTableContainer').removeClass('d-none');
            $('#modalSalesChartViewBtn').removeClass('active');
            $('#modalSalesTableViewBtn').addClass('active');

            // Sync main card view
            syncMainViewWithModal();
        });

        function syncModalViewWithMain() {
            if (currentViewMode === 'chart') {
                $('#modalSalesChartContainer').removeClass('d-none');
                $('#modalSalesTableContainer').addClass('d-none');
                $('#modalSalesChartViewBtn').addClass('active');
                $('#modalSalesTableViewBtn').removeClass('active');
            } else {
                $('#modalSalesChartContainer').addClass('d-none');
                $('#modalSalesTableContainer').removeClass('d-none');
                $('#modalSalesChartViewBtn').removeClass('active');
                $('#modalSalesTableViewBtn').addClass('active');
            }
        }

        function syncMainViewWithModal() {
            if (currentViewMode === 'chart') {
                $('#salesChartContainer').removeClass('d-none');
                $('#salesTableContainer').addClass('d-none');
                $('#salesChartViewBtn').addClass('active');
                $('#salesTableViewBtn').removeClass('active');
            } else {
                $('#salesChartContainer').addClass('d-none');
                $('#salesTableContainer').removeClass('d-none');
                $('#salesChartViewBtn').removeClass('active');
                $('#salesTableViewBtn').addClass('active');
            }
        }

        // Modal chart rendering
        function renderModalSales(data) {
            const grouping = $('#modalSalesGrouping').val();
            const salesGrouped = {};

            const formatDisplayDate = (isoDate, mode) => {
                const date = new Date(isoDate);
                const year = date.getFullYear();
                const month = date.toLocaleString('en-US', { month: 'short' });
                const day = String(date.getDate()).padStart(2, '0');
                const weekday = date.toLocaleString('en-US', { weekday: 'short' });

                if (mode === 'yearly') return `${year}`;
                if (mode === 'monthly') return `${month}/${year}`;
                return `${day}/${month}/${year}, ${weekday}`;
            };

            data.forEach(bill => {
                const dateObj = new Date(bill.billingDate);
                let key = bill.billingDate.split('T')[0];

                if (grouping === 'monthly')
                    key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                else if (grouping === 'yearly')
                    key = `${dateObj.getFullYear()}`;

                salesGrouped[key] = (salesGrouped[key] || 0) + bill.finalTotal;
            });

            const keys = Object.keys(salesGrouped).sort();
            const tbody = $('#modalSalesTable tbody').empty();

            let total = 0;
            keys.forEach((k, i) => {
                const val = salesGrouped[k];
                total += val;
                const display = formatDisplayDate(grouping === 'daily' ? k : k + '-01', grouping);
                tbody.append(`<tr><td>${i + 1}</td><td>${display}</td><td>${val.toFixed(2)}</td></tr>`);
            });

            const avg = total / keys.length || 0;
            $('#modalTotalSalesCell').text(`₹ ${total.toFixed(2)}`);
            $('#modalAverageSalesCell').text(`₹ ${avg.toFixed(2)}`);

            const labels = keys.map(k => formatDisplayDate(grouping === 'daily' ? k : k + '-01', grouping));
            const values = keys.map(k => salesGrouped[k]);

            const ctx = document.getElementById('modalSalesBarChart').getContext('2d');
            if (modalSalesChart) modalSalesChart.destroy();

            modalSalesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Total Sales',
                            data: values,
                            backgroundColor: 'rgba(10,47,79,0.8)',
                            borderColor: 'rgba(10,47,79)',
                            borderWidth: 1
                        },
                        {
                            label: 'Average',
                            data: new Array(values.length).fill(avg),
                            type: 'line',
                            borderColor: 'rgba(10,47,79)',
                            borderDash: [3, 3],
                            pointRadius: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    return ctx.dataset.label === 'Average'
                                        ? ` Average: ₹ ${ctx.raw.toFixed(2)}`
                                        : ` Total Sales: ₹ ${ctx.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Reusable Toast Function

        function showToast(message, bgColorClass = 'text-bg-primary') {
            const toastEl = document.getElementById('mainToast');
            const toastBody = document.getElementById('mainToastBody');

            toastEl.className = `toast align-items-center ${bgColorClass} border-0`;
            toastBody.textContent = message;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

    </script>
</body>

</html>