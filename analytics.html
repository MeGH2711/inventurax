<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inventurax | Analytics</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/lightTheme.css">
    <link rel="stylesheet" href="css/material-font-icons.css">
</head>

<body>

    <div class="d-flex" id="wrapper">

        <!-- Sidebar -->
        <div class="shadow-sm" id="sidebar-wrapper">
            <div class="sidebar-heading p-3 d-flex justify-content-between align-items-center">
                <img id="sidebarLogoFull" src="images/inventuraxLogoWhite.png" alt="Full Logo" class="img-fluid">
                <img id="sidebarLogoIcon" src="images/inventuraxIconWhite.png" alt="Icon Logo" class="img-fluid d-none">
            </div>

            <!-- Scrollable content wrapper -->
            <div class="sidebar-content">
                <div class="list-group list-group-flush flex-grow-1">
                    <a href="/dashboard" class="list-group-item list-group-item-sidebar" title="Dashboard">
                        <i class="gsymbols-round gicon-home fs-5"></i><span class="link-text">Dashboard</span>
                    </a>
                    <a href="/productlisting" class="list-group-item list-group-item-sidebar" title="Product Listing">
                        <i class="gsymbols-round gicon-inventory fs-5"></i><span class="link-text">Product
                            Listing</span>
                    </a>
                    <a href="/billing" class="list-group-item list-group-item-sidebar" title="Billing">
                        <i class="gsymbols-round gicon-receipt_long fs-5"></i><span class="link-text">Billing</span>
                    </a>
                    <a href="/billlogs" class="list-group-item list-group-item-sidebar" title="Bill Logs">
                        <i class="gsymbols-round gicon-auto_stories fs-5"></i><span class="link-text">Bill Logs</span>
                    </a>
                    <a class="list-group-item list-group-item-sidebar active" title="Analytics">
                        <i class="gsymbols-round gicon-insights fs-5"></i><span class="link-text">Analytics</span>
                    </a>
                    <a href="/customers" class="list-group-item list-group-item-sidebar" title="Customers">
                        <i class="gsymbols-round gicon-group fs-5"></i><span class="link-text">Customers</span>
                    </a>
                </div>
            </div>

            <!-- Bottom Toggle Button -->
            <div class="text-center p-3 sidebar-toggle-wrapper">
                <button class="btn btn-outline-light w-100" id="toggleSidebar">
                    <i class="gsymbols-round gicon-chevron_left" id="toggleIcon"></i>
                </button>
            </div>
        </div>

        <!-- Main Page content -->
        <div id="mainPageContent" class="p-4 flex-grow-1">

            <!-- Header Section -->
            <div class="container-fluid d-flex justify-content-end">
                <div class="dropdown profileButton">
                    <button class="btn btn-sm btn-darkblue dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        Username
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item dropdown-item-signout" href="/logout">Sign Out</a></li>
                    </ul>
                </div>
            </div>

            <div class="container-fluid my-4">

                <div class="row">

                    <!-- Daily Stats Section -->
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm border-0 rounded-3 overflow-hidden dailyStatsCard">
                            <div class="card-header dailyStatsHeader py-3">
                                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="gsymbols-round gicon-today fs-3 me-2"></i> Daily Stats
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span id="dailyStatsDate" class="fw-light text-light"></span>
                                    </div>
                                </h5>
                            </div>
                            <div class="card-body bg-light-subtle">
                                <div class="row g-4">

                                    <!-- Daily Income Card -->
                                    <div class="col-md-4">
                                        <div class="card h-100 border-0 gradient-card3 shadow-sm rounded-4">
                                            <div class="card-body d-flex flex-column justify-content-between p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="card-title text-muted fw-semibold">Daily Income</h6>
                                                </div>
                                                <p id="dailyIncome" class="card-text display-5 fw-bold text-dark mb-0">â‚¹
                                                    --
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Daily Customer Count Card -->
                                    <div class="col-md-4">
                                        <div class="card h-100 border-0 gradient-card3 shadow-sm rounded-4">
                                            <div class="card-body d-flex flex-column justify-content-between p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="card-title text-muted fw-semibold">Daily Customers</h6>
                                                </div>
                                                <p id="dailyCustomerCount"
                                                    class="card-text display-5 fw-bold text-dark mb-0">--
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Daily Bill Count Card -->
                                    <div class="col-md-4">
                                        <div class="card h-100 border-0 gradient-card3 shadow-sm rounded-4">
                                            <div class="card-body d-flex flex-column justify-content-between p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="card-title text-muted fw-semibold">Bills Generated Today
                                                    </h6>
                                                </div>
                                                <p id="dailyBillCount" class="card-text display-5 fw-bold mb-0">--</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Section -->
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm border-0 rounded-3 overflow-hidden analyticsCard">
                            <div class="card-header py-3">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div class="d-flex align-items-center">
                                        <i class="gsymbols-round gicon-bar_chart fs-3 me-2"></i>
                                        <span class="fw-semibold fs-5">Sales Overview</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-row">

                                        <!-- Sales Group Picker -->
                                        <select id="salesGrouping" class="form-select form-select-sm w-auto">
                                            <option value="daily" selected>Daily</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>

                                        <!-- Date Range Picker -->
                                        <div class="input-group input-group-sm">
                                            <input type="date" id="salesStartDate" class="form-control form-control-sm">
                                            <span class="input-group-text">to</span>
                                            <input type="date" id="salesEndDate" class="form-control form-control-sm">
                                            <button class="btn btn-sm btn-darkblue"
                                                id="salesApplyDateFilter">Apply</button>
                                        </div>

                                        <!-- Chart/Table Toggle -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-light active" type="button"
                                                id="salesChartViewBtn" title="Chart View">
                                                <i class="gsymbols-round gicon-bar_chart"></i>
                                            </button>
                                            <button class="btn btn-outline-light" type="button" id="salesTableViewBtn"
                                                title="Table View">
                                                <i class="gsymbols-round gicon-table"></i>
                                            </button>
                                        </div>

                                        <!-- Expand Button -->
                                        <div>
                                            <button class="btn btn-sm btn-light" id="expandSalesCardBtn">
                                                <i class="gsymbols-round gicon-open_in_full"></i>
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="card-body bg-light-subtle p-0" style="height: 400px; overflow: hidden;">
                                <div id="salesChartContainer" class="h-100 overflow-auto p-3">
                                    <canvas id="salesBarChart" style="width: 100%; height: 300px;"></canvas>
                                </div>
                                <div id="salesTableContainer" class="d-none h-100 overflow-auto p-3">
                                    <div class="card border-1 roundedTableCard">
                                        <div class="table-responsive">
                                            <table
                                                class="table table-sm table-bordered align-middle text-center roundedTable"
                                                id="salesTable">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center">Sr. No.</th>
                                                        <th class="text-center">Date</th>
                                                        <th class="text-center">Total Sales (â‚¹)</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td class="text-center bg-transparent fw-bold" colspan="2">Total
                                                            Sales
                                                            </th>
                                                        <td class="text-center bg-transparent fw-bold"
                                                            id="totalSalesCell">â‚¹
                                                            0.00</th>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center bg-transparent fw-bold" colspan="2">
                                                            Average
                                                            Amount</th>
                                                        <td class="text-center bg-transparent fw-bold"
                                                            id="averageSalesCell">â‚¹
                                                            0.00</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Selling Product -->
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm border-0 rounded-3 overflow-hidden analyticsCard">
                            <div class="card-header py-3">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div class="d-flex align-items-center">
                                        <i class="gsymbols-round gicon-local_mall fs-3 me-2"></i>
                                        <span class="fw-semibold fs-5">Top Selling Products</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-row">

                                        <!-- Sales Group Picker -->
                                        <select id="tspGrouping" class="form-select form-select-sm w-auto">
                                            <option value="daily" selected>Daily</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>

                                        <!-- Date Range Picker -->
                                        <div class="input-group input-group-sm">
                                            <input type="date" id="tspStartDate" class="form-control form-control-sm">
                                            <span class="input-group-text">to</span>
                                            <input type="date" id="tspEndDate" class="form-control form-control-sm">
                                            <button class="btn btn-sm btn-darkblue"
                                                id="tspApplyDateFilter">Apply</button>
                                        </div>

                                        <!-- Chart/Table Toggle -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-light active" type="button"
                                                id="tspChartViewBtn" title="Chart View">
                                                <i class="gsymbols-round gicon-bar_chart"></i>
                                            </button>
                                            <button class="btn btn-outline-light" type="button" id="tspTableViewBtn"
                                                title="Table View">
                                                <i class="gsymbols-round gicon-table"></i>
                                            </button>
                                        </div>

                                        <!-- Expand Button -->
                                        <div>
                                            <button class="btn btn-sm btn-light" id="expandTspCardBtn">
                                                <i class="gsymbols-round gicon-open_in_full"></i>
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="card-body bg-light-subtle p-0" style="height: 400px; overflow: hidden;">
                                <div id="tspChartContainer" class="h-100 overflow-auto p-3">
                                    <canvas id="topProductsBarChart" style="width: 100%; height: 300px;"></canvas>
                                </div>
                                <div id="tspTableContainer" class="d-none h-100 overflow-auto p-3">
                                    <div class="card border-1 roundedTableCard">
                                        <div class="table-responsive">
                                            <table
                                                class="table table-sm table-bordered align-middle text-center roundedTable"
                                                id="tspTable">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center">Sr. No.</th>
                                                        <th class="text-center">Product</th>
                                                        <th class="text-center">Quantity Sold</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Distribution by Category -->
                    <div class="col-4 mb-4">
                        <div class="card h-100 shadow-sm border-0 rounded-3 overflow-hidden analyticsCard">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="gsymbols-round gicon-pie_chart fs-4 me-2"></i>
                                    <span class="fw-semibold fs-6">Product Distribution by Category</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-end gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-light active" id="categoryChartViewBtn"
                                            title="Chart View">
                                            <i class="gsymbols-round gicon-pie_chart"></i>
                                        </button>
                                        <button class="btn btn-outline-light" id="categoryTableViewBtn"
                                            title="Table View">
                                            <i class="gsymbols-round gicon-table"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-light" id="expandCategoryChartBtn">
                                        <i class="gsymbols-round gicon-open_in_full"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body bg-light-subtle d-flex justify-content-center align-items-center"
                                style="height: 400px;">
                                <div id="categoryChartContainer"
                                    class="d-flex justify-content-center align-items-center h-100">
                                    <canvas id="categoryPieChart" style="width: 100%; height: 100%;"></canvas>
                                </div>
                                <div id="categoryTableContainer" class="d-none h-100 w-100 p-3">
                                    <div class="table-responsive card roundedTableCard">
                                        <table class="table table-sm table-bordered text-center roundedTable">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No.</th>
                                                    <th>Category</th>
                                                    <th>Count</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="categoryTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mode of Payment Pie Chart -->
                    <div class="col-4 mb-4">
                        <div class="card h-100 shadow-sm border-0 rounded-3 overflow-hidden analyticsCard">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="gsymbols-round gicon-payments fs-4 me-2"></i>
                                    <span class="fw-semibold fs-6">Payment Mode Distribution</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-end gap-2">
                                    <div class=" btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-light active" id="paymentChartViewBtn"
                                            title="Chart View">
                                            <i class="gsymbols-round gicon-pie_chart"></i>
                                        </button>
                                        <button class="btn btn-outline-light" id="paymentTableViewBtn"
                                            title="Table View">
                                            <i class="gsymbols-round gicon-table"></i>
                                        </button>
                                    </div>

                                    <button class="btn btn-sm btn-light" id="expandPaymentChartBtn">
                                        <i class="gsymbols-round gicon-open_in_full"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body bg-light-subtle d-flex justify-content-center align-items-center"
                                style="height: 400px;">
                                <div id="paymentChartContainer"
                                    class="h-100 d-flex justify-content-center align-items-center">
                                    <canvas id="paymentPieChart" style="width: 100%; height: 100%;"></canvas>
                                </div>
                                <div id="paymentTableContainer" class="d-none h-100 w-100 p-3">
                                    <div class="table-responsive card roundedTableCard">
                                        <table class="table table-sm table-bordered text-center roundedTable">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No.</th>
                                                    <th>Mode</th>
                                                    <th>Count</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mode of Delivery Pie Chart -->
                    <div class="col-4 mb-4">
                        <div class="card h-100 shadow-sm border-0 rounded-3 overflow-hidden analyticsCard">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="gsymbols-round gicon-local_shipping fs-4 me-2"></i>
                                    <span class="fw-semibold fs-6">Delivery Mode Distribution</span>
                                </div>
                                <div class="d-flex justify-content-end align-items-center gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-light active" id="deliveryChartViewBtn"
                                            title="Chart View">
                                            <i class="gsymbols-round gicon-pie_chart"></i>
                                        </button>
                                        <button class="btn btn-outline-light" id="deliveryTableViewBtn"
                                            title="Table View">
                                            <i class="gsymbols-round gicon-table"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-light" id="expandDeliveryChartBtn">
                                        <i class="gsymbols-round gicon-open_in_full"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body bg-light-subtle d-flex justify-content-center align-items-center"
                                style="height: 400px;">
                                <div id="deliveryChartContainer"
                                    class="d-flex justify-content-center align-items-center h-100">
                                    <canvas id="deliveryPieChart" style="width: 100%; height: 100%;"></canvas>
                                </div>
                                <div id="deliveryTableContainer" class="d-none h-100 w-100 p-3">
                                    <div class="table-responsive card roundedTableCard">
                                        <table class="table table-sm table-bordered text-center roundedTable">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No.</th>
                                                    <th>Mode</th>
                                                    <th>Count</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="deliveryTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bills Generated Chart -->
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm border-0 rounded-3 analyticsCard">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="gsymbols-round gicon-insert_chart fs-4 me-2"></i>
                                    <span class="fw-semibold fs-5">Bills Generated</span>
                                </div>
                                <div class="d-flex gap-2 align-items-center">
                                    <select id="billCountGrouping" class="form-select form-select-sm w-auto">
                                        <option value="daily" selected>Daily</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <div class="input-group input-group-sm">
                                        <input type="date" id="billCountStart" class="form-control form-control-sm">
                                        <span class="input-group-text">to</span>
                                        <input type="date" id="billCountEnd" class="form-control form-control-sm">
                                        <button class="btn btn-sm btn-darkblue" id="applyBillCountFilter">Apply</button>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-light active" id="billCountChartViewBtn"
                                            title="Chart View">
                                            <i class="gsymbols-round gicon-bar_chart"></i>
                                        </button>
                                        <button class="btn btn-outline-light" id="billCountTableViewBtn"
                                            title="Table View">
                                            <i class="gsymbols-round gicon-table"></i>
                                        </button>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-light" id="expandBillCountCardBtn">
                                            <i class="gsymbols-round gicon-open_in_full"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body bg-light-subtle p-0" style="height: 400px; overflow: hidden;">
                                <div id="billCountChartContainer" class="h-100 overflow-auto p-3">
                                    <canvas id="billCountLineChart" style="width: 100%; height: 100%;"></canvas>
                                </div>
                                <div id="billCountTableContainer" class="d-none h-100 overflow-auto p-3">
                                    <div class="card border-1 roundedTableCard">
                                        <div class="table-responsive">
                                            <table
                                                class="table table-sm table-bordered align-middle text-center roundedTable"
                                                id="billCountTable">
                                                <thead>
                                                    <tr>
                                                        <th>Sr. No.</th>
                                                        <th>Date</th>
                                                        <th>Number of Bills</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td colspan="2" class="text-center fw-bold bg-transparent">Total
                                                            Bills Generated
                                                        </td>
                                                        <td id="billCountTotalCell" class="fw-bold bg-transparent">0
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="2" class="text-center fw-bold bg-transparent">
                                                            Average Bills Generated
                                                        </td>
                                                        <td id="billCountAverageCell" class="fw-bold bg-transparent">0
                                                        </td>
                                                    </tr>
                                                </tfoot>
                                            </table>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <!-- Footer Section -->
            <footer class="mt-auto pt-3 border-top text-center small text-muted">
                <div class="container">
                    &copy; 2025 Inventurax. All rights reserved. | Version 1.0.0
                </div>
            </footer>

        </div>
    </div>

    <!-- Modal -->

    <!-- Fullscreen Modal for Sales Overview -->
    <div class="modal fade" id="salesFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-bar_chart fs-3 me-2"></i>Sales Overview
                        (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center flex-row gap-2 mb-3">
                            <!-- Controls -->
                            <div class="d-flex align-items-center gap-2 flex-row">
                                <select id="modalSalesGrouping" class="form-select form-select-sm w-auto">
                                    <option value="daily">Daily</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="modalSalesStartDate" class="form-control">
                                    <span class="input-group-text">to</span>
                                    <input type="date" id="modalSalesEndDate" class="form-control">
                                    <button class="btn btn-sm btn-darkblue"
                                        id="modalSalesApplyDateFilter">Apply</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-darkblue active" id="modalSalesChartViewBtn"><i
                                            class="gsymbols-round gicon-bar_chart"></i></button>
                                    <button class="btn btn-outline-darkblue" id="modalSalesTableViewBtn"><i
                                            class="gsymbols-round gicon-table"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Chart/Table Containers -->
                        <div class="p-2" style="height: 75vh;">
                            <div id="modalSalesChartContainer" class="h-100 overflow-auto p-2">
                                <canvas id="modalSalesBarChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                            <div id="modalSalesTableContainer" class="d-none h-100 overflow-auto p-2">
                                <div class="card roundedTableCard">
                                    <table class="table table-sm table-bordered text-center roundedTable"
                                        id="modalSalesTable">
                                        <thead>
                                            <tr>
                                                <th>Sr. No.</th>
                                                <th>Date</th>
                                                <th>Total Sales (â‚¹)</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td class="bg-transparent fw-bold" colspan="2">Total Sales</td>
                                                <td class="bg-transparent fw-bold" id="modalTotalSalesCell">â‚¹ 0.00
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="bg-transparent fw-bold" colspan="2">Average</td>
                                                <td class="bg-transparent fw-bold" id="modalAverageSalesCell">â‚¹ 0.00
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal for Top Selling Products -->
    <div class="modal fade" id="tspFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-local_mall fs-3 me-2"></i>Top Selling Products (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center flex-row gap-2 mb-3">
                            <div class="d-flex align-items-center gap-2 flex-row">
                                <select id="modalTspGrouping" class="form-select form-select-sm w-auto">
                                    <option value="daily">Daily</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="modalTspStartDate" class="form-control">
                                    <span class="input-group-text">to</span>
                                    <input type="date" id="modalTspEndDate" class="form-control">
                                    <button class="btn btn-sm btn-darkblue" id="modalTspApplyDateFilter">Apply</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-darkblue active" id="modalTspChartViewBtn"><i
                                            class="gsymbols-round gicon-bar_chart"></i></button>
                                    <button class="btn btn-outline-darkblue" id="modalTspTableViewBtn"><i
                                            class="gsymbols-round gicon-table"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="p-2" style="height: 75vh;">
                            <div id="modalTspChartContainer" class="h-100 overflow-auto p-2">
                                <canvas id="modalTopProductsBarChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                            <div id="modalTspTableContainer" class="d-none h-100 overflow-auto p-2">
                                <div class="card roundedTableCard">
                                    <table class="table table-sm table-bordered text-center roundedTable"
                                        id="modalTspTable">
                                        <thead>
                                            <tr>
                                                <th>Sr. No.</th>
                                                <th>Product</th>
                                                <th>Quantity</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal for Product Distribution by Category -->
    <div class="modal fade" id="categoryFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-pie_chart fs-3 me-2"></i>Product Distribution by Category
                        (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm ms-3" role="group">
                                <button class="btn btn-outline-darkblue active" id="modalCategoryChartViewBtn"><i
                                        class="gsymbols-round gicon-pie_chart"></i></button>
                                <button class="btn btn-outline-darkblue" id="modalCategoryTableViewBtn"><i
                                        class="gsymbols-round gicon-table"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="container-fluid p-3" style="height: 80vh;">
                        <div id="modalCategoryChartContainer" class="h-100 d-flex justify-content-center">
                            <canvas id="modalCategoryPieChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                        <div id="modalCategoryTableContainer" class="d-none h-100 overflow-auto">
                            <div class="table-responsive card roundedTableCard">
                                <table class="table table-sm table-bordered text-center roundedTable">
                                    <thead>
                                        <tr>
                                            <th>Sr. No.</th>
                                            <th>Category</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modalCategoryTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal for Payment Mode Pie Chart -->
    <div class="modal fade" id="paymentFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-payments fs-3 me-2"></i>Payment Mode Distribution (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm ms-3" role="group">
                                <button class="btn btn-outline-darkblue active" id="modalPaymentChartViewBtn">
                                    <i class="gsymbols-round gicon-pie_chart"></i>
                                </button>
                                <button class="btn btn-outline-darkblue" id="modalPaymentTableViewBtn">
                                    <i class="gsymbols-round gicon-table"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="container-fluid p-3" style="height: 80vh;">
                        <div id="modalPaymentChartContainer" class="d-flex justify-content-center h-100">
                            <canvas id="modalPaymentPieChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                        <div id="modalPaymentTableContainer" class="d-none h-100 overflow-auto">
                            <div class="table-responsive card roundedTableCard">
                                <table class="table table-sm table-bordered text-center roundedTable">
                                    <thead>
                                        <tr>
                                            <th>Sr. No.</th>
                                            <th>Mode</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modalPaymentTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal for Delivery Mode Pie Chart -->
    <div class="modal fade" id="deliveryFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-local_shipping fs-3 me-2"></i>Delivery Mode Distribution
                        (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm ms-3" role="group">
                                <button class="btn btn-outline-darkblue active" id="modalDeliveryChartViewBtn">
                                    <i class="gsymbols-round gicon-pie_chart"></i>
                                </button>
                                <button class="btn btn-outline-darkblue" id="modalDeliveryTableViewBtn">
                                    <i class="gsymbols-round gicon-table"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="container-fluid p-3" style="height: 80vh;">
                        <div id="modalDeliveryChartContainer" class=" d-flex justify-content-center h-100">
                            <canvas id="modalDeliveryPieChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                        <div id="modalDeliveryTableContainer" class="d-none h-100 overflow-auto">
                            <div class="table-responsive card roundedTableCard">
                                <table class="table table-sm table-bordered text-center roundedTable">
                                    <thead>
                                        <tr>
                                            <th>Sr. No.</th>
                                            <th>Mode</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modalDeliveryTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal for Bills Generated -->
    <div class="modal fade" id="billCountFullscreenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content analyticsModal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="gsymbols-round gicon-insert_chart fs-3 me-2"></i>Bills Generated (Fullscreen)
                    </h5>
                    <button type="button" class="btn-close"
                        style="filter: invert(1) grayscale(100%) brightness(200%); opacity: 1;" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">

                        <!-- Controls -->
                        <div class="d-flex justify-content-between align-items-center flex-row gap-2 mb-3">
                            <div class="d-flex align-items-center gap-2 flex-row">
                                <select id="modalBillCountGrouping" class="form-select form-select-sm w-auto">
                                    <option value="daily">Daily</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="modalBillCountStart" class="form-control">
                                    <span class="input-group-text">to</span>
                                    <input type="date" id="modalBillCountEnd" class="form-control">
                                    <button class="btn btn-sm btn-darkblue" id="modalBillCountApply">Apply</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-darkblue active" id="modalBillCountChartViewBtn">
                                        <i class="gsymbols-round gicon-bar_chart"></i>
                                    </button>
                                    <button class="btn btn-outline-darkblue" id="modalBillCountTableViewBtn">
                                        <i class="gsymbols-round gicon-table"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Chart / Table containers -->
                        <div class="p-2" style="height: 80vh;">
                            <div id="modalBillCountChartContainer" class="h-100 overflow-auto p-2">
                                <canvas id="modalBillCountChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                            <div id="modalBillCountTableContainer" class="d-none h-100 overflow-auto p-2">
                                <div class="card roundedTableCard">
                                    <table class="table table-sm table-bordered text-center roundedTable"
                                        id="modalBillCountTable">
                                        <thead>
                                            <tr>
                                                <th>Sr. No.</th>
                                                <th>Date</th>
                                                <th>Number of Bills</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="2" class="bg-transparent fw-bold">Total</td>
                                                <td id="modalBillCountTotalCell" class="bg-transparent fw-bold">0</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" class="bg-transparent fw-bold">Average</td>
                                                <td id="modalBillCountAverageCell" class="bg-transparent fw-bold">0</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="mainToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="mainToastBody">
                    <!-- Message goes here -->
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/chart.umd.js"></script>
    <script src="js/chartjs-plugin-datalabels@2.js"></script>

    <script>
        // Session check
        fetch('/session-check')
            .then(res => res.json())
            .then(data => {
                if (!data.loggedIn) {
                    window.location.href = '/';
                } else {
                    document.querySelector('.profileButton .dropdown-toggle').textContent = data.username;
                }
            })
            .catch(() => {
                window.location.href = '/';
            });

        // Daily Stats

        const today = new Date();

        const day = today.toLocaleDateString('en-IN', { weekday: 'long' });
        const date = today.getDate().toString().padStart(2, '0');
        const month = today.toLocaleDateString('en-IN', { month: 'long' });
        const year = today.getFullYear();

        document.getElementById('dailyStatsDate').textContent = `${day}, ${date} ${month}, ${year}`;

        fetch('/daily-income')
            .then(res => res.json())
            .then(data => {
                document.getElementById('dailyIncome').textContent = `â‚¹ ${data.dailyIncome.toLocaleString()}`;
            })
            .catch(err => {
                console.error('Error fetching daily income:', err);
                document.getElementById('dailyIncome').textContent = 'N/A';
            });

        fetch('/daily-customer-count')
            .then(res => res.json())
            .then(data => {
                document.getElementById('dailyCustomerCount').textContent = data.dailyCustomerCount;
            })
            .catch(err => {
                console.error('Error fetching daily customer count:', err);
                document.getElementById('dailyCustomerCount').textContent = 'N/A';
            });

        fetch('/daily-bill-count')
            .then(res => res.json())
            .then(data => {
                document.getElementById('dailyBillCount').textContent = data.dailyBillCount;
            })
            .catch(err => {
                console.error('Error fetching daily bill count:', err);
                document.getElementById('dailyBillCount').textContent = 'N/A';
            });

        $(document).ready(function () {

            fetch('/get-bills')
                .then(res => res.json())
                .then(data => {

                    allBills = data;

                    const dates = allBills.map(bill => bill.billingDate.split('T')[0]);
                    dates.sort();

                    const minDate = dates[0];
                    const maxDate = dates[dates.length - 1];

                    $('#salesStartDate').val(minDate);
                    $('#salesEndDate').val(maxDate);

                    renderSales(allBills);

                    $('#tspStartDate').val(minDate);
                    $('#tspEndDate').val(maxDate);

                    renderTopProductsChart(minDate, maxDate);

                    $('#billCountStart').val(minDate);
                    $('#billCountEnd').val(maxDate);

                    renderBillCountChart(minDate, maxDate, $('#billCountGrouping').val());

                });

            $('#salesApplyDateFilter').on('click', function () {
                const start = $('#salesStartDate').val();
                const end = $('#salesEndDate').val();

                if (!start || !end) {
                    showToast('Please select both start and end dates.', 'text-bg-warning');
                    return;
                }

                currentStartDate = start;
                currentEndDate = end;

                $('#modalSalesStartDate').val(currentStartDate);
                $('#modalSalesEndDate').val(currentEndDate);

                const filtered = allBills.filter(bill => {
                    const billDate = bill.billingDate.split('T')[0];
                    return billDate >= start && billDate <= end;
                });

                renderSales(filtered);

                if ($('#salesFullscreenModal').hasClass('show')) {
                    renderModalSales(filtered);
                }
            });

            const minDate = allBills?.[0]?.billingDate?.split('T')[0];
            const maxDate = allBills?.[allBills.length - 1]?.billingDate?.split('T')[0];
            $('#tspStartDate').val(minDate);
            $('#tspEndDate').val(maxDate);

            $('#tspGrouping').on('change', function () {
                const start = $('#tspStartDate').val();
                const end = $('#tspEndDate').val();
                if (start && end) {
                    renderTopProductsChart(start, end);
                }
            });

            renderTopProductsChart(minDate, maxDate);
            renderCategoryPieChart();
            renderPaymentPieChart();
            renderDeliveryPieChart();

        });

        let modalSalesChart;

        let currentViewMode = 'chart';

        let currentStartDate = '';
        let currentEndDate = '';

        // Toggle functionality

        $('#salesChartViewBtn').on('click', function () {
            currentViewMode = 'chart';
            $('#salesChartContainer').removeClass('d-none');
            $('#salesTableContainer').addClass('d-none');
            $('#salesChartViewBtn').addClass('active');
            $('#salesTableViewBtn').removeClass('active');

            syncModalViewWithMain();
        });

        $('#salesTableViewBtn').on('click', function () {
            currentViewMode = 'table';
            $('#salesChartContainer').addClass('d-none');
            $('#salesTableContainer').removeClass('d-none');
            $('#salesChartViewBtn').removeClass('active');
            $('#salesTableViewBtn').addClass('active');

            syncModalViewWithMain();
        });

        $('#salesGrouping').on('change', function () {
            $('#modalSalesGrouping').val(this.value);
            $('#salesApplyDateFilter').click();
        });

        let allBills = [];

        function renderSales(filteredData) {
            const grouping = $('#salesGrouping').val();
            const salesGrouped = {};

            const formatDisplayDate = (isoDate, mode) => {
                const date = new Date(isoDate);
                if (isNaN(date)) return 'Invalid Date';
                const year = date.getFullYear();
                const month = date.toLocaleString('en-US', { month: 'short' });
                const day = String(date.getDate()).padStart(2, '0');
                const weekday = date.toLocaleString('en-US', { weekday: 'short' });

                if (mode === 'yearly') return `${year}`;
                if (mode === 'monthly') return `${month}/${year}`;
                return `${day}/${month}/${year}, ${weekday}`;
            };

            filteredData.forEach(bill => {
                const dateObj = new Date(bill.billingDate);
                let key;

                switch (grouping) {
                    case 'yearly':
                        key = `${dateObj.getFullYear()}`;
                        break;
                    case 'monthly':
                        key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        break;
                    default:
                        key = bill.billingDate.split('T')[0]; // daily
                }

                salesGrouped[key] = (salesGrouped[key] || 0) + bill.finalTotal;
            });

            const sortedKeys = Object.keys(salesGrouped).sort();
            const tbody = $('#salesTable tbody');
            tbody.empty();

            let total = 0;
            sortedKeys.forEach((key, i) => {
                const value = salesGrouped[key];
                total += value;

                const displayDate = formatDisplayDate(
                    grouping === 'daily' ? key : key + '-01',
                    grouping
                );

                const row = `
                    <tr>
                        <td class="text-center">${i + 1}</td>
                        <td class="text-center">${displayDate}</td>
                        <td class="text-center">${value.toFixed(2)}</td>
                    </tr>
                `;
                tbody.append(row);
            });

            const average = total / sortedKeys.length || 0;
            $('#totalSalesCell').text(`â‚¹ ${total.toFixed(2)}`);
            $('#averageSalesCell').text(`â‚¹ ${average.toFixed(2)}`);

            const labels = sortedKeys.map(k =>
                formatDisplayDate(grouping === 'daily' ? k : k + '-01', grouping)
            );

            const sales = sortedKeys.map(k => salesGrouped[k]);

            const ctx = document.getElementById('salesBarChart').getContext('2d');
            if (window.salesChart) window.salesChart.destroy();

            window.salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Total Sales',
                            data: sales,
                            backgroundColor: 'rgba(10, 47, 79, 0.8)',
                            borderColor: 'rgba(10, 47, 79)',
                            borderWidth: 1
                        },
                        {
                            label: 'Average',
                            data: new Array(sales.length).fill(average),
                            type: 'line',
                            borderColor: 'rgba(10, 47, 79)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 1.5,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function (ctx) {
                                    const label = ctx.dataset.label;
                                    return label === 'Average'
                                        ? ` Average: â‚¹ ${ctx.raw.toFixed(2)}`
                                        : ` Total Sales: â‚¹ ${ctx.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        $('#expandSalesCardBtn').on('click', function () {
            // Sync dates
            $('#modalSalesStartDate').val(currentStartDate || $('#salesStartDate').val());
            $('#modalSalesEndDate').val(currentEndDate || $('#salesEndDate').val());

            // Sync grouping
            $('#modalSalesGrouping').val($('#salesGrouping').val());

            // Filter and render both
            const filtered = allBills.filter(bill => {
                const billDate = bill.billingDate.split('T')[0];
                return billDate >= $('#modalSalesStartDate').val() &&
                    billDate <= $('#modalSalesEndDate').val();
            });

            renderModalSales(filtered);
            syncModalViewWithMain();

            const modal = new bootstrap.Modal(document.getElementById('salesFullscreenModal'));
            modal.show();

            setTimeout(() => {
                if (modalSalesChart) modalSalesChart.resize();
            }, 500);
        });

        // Modal event handlers
        $('#modalSalesApplyDateFilter').on('click', function () {
            const start = $('#modalSalesStartDate').val();
            const end = $('#modalSalesEndDate').val();

            if (!start || !end) {
                showToast('Please select both start and end dates.', 'text-bg-warning');
                return;
            }

            currentStartDate = start;
            currentEndDate = end;

            // Apply to main card
            $('#salesStartDate').val(currentStartDate);
            $('#salesEndDate').val(currentEndDate);

            const filtered = allBills.filter(bill => {
                const billDate = bill.billingDate.split('T')[0];
                return billDate >= start && billDate <= end;
            });

            renderModalSales(filtered);
            renderSales(filtered);
        });

        $('#modalSalesGrouping').on('change', function () {
            $('#salesGrouping').val(this.value);
            $('#modalSalesApplyDateFilter').click();
        });

        $('#modalSalesChartViewBtn').on('click', function () {
            currentViewMode = 'chart';
            $('#modalSalesChartContainer').removeClass('d-none');
            $('#modalSalesTableContainer').addClass('d-none');
            $('#modalSalesChartViewBtn').addClass('active');
            $('#modalSalesTableViewBtn').removeClass('active');

            // Sync main card view
            syncMainViewWithModal();
        });

        $('#modalSalesTableViewBtn').on('click', function () {
            currentViewMode = 'table';
            $('#modalSalesChartContainer').addClass('d-none');
            $('#modalSalesTableContainer').removeClass('d-none');
            $('#modalSalesChartViewBtn').removeClass('active');
            $('#modalSalesTableViewBtn').addClass('active');

            // Sync main card view
            syncMainViewWithModal();
        });

        function syncModalViewWithMain() {
            if (currentViewMode === 'chart') {
                $('#modalSalesChartContainer').removeClass('d-none');
                $('#modalSalesTableContainer').addClass('d-none');
                $('#modalSalesChartViewBtn').addClass('active');
                $('#modalSalesTableViewBtn').removeClass('active');
            } else {
                $('#modalSalesChartContainer').addClass('d-none');
                $('#modalSalesTableContainer').removeClass('d-none');
                $('#modalSalesChartViewBtn').removeClass('active');
                $('#modalSalesTableViewBtn').addClass('active');
            }
        }

        function syncMainViewWithModal() {
            if (currentViewMode === 'chart') {
                $('#salesChartContainer').removeClass('d-none');
                $('#salesTableContainer').addClass('d-none');
                $('#salesChartViewBtn').addClass('active');
                $('#salesTableViewBtn').removeClass('active');
            } else {
                $('#salesChartContainer').addClass('d-none');
                $('#salesTableContainer').removeClass('d-none');
                $('#salesChartViewBtn').removeClass('active');
                $('#salesTableViewBtn').addClass('active');
            }
        }

        // Modal chart rendering

        function renderModalSales(data) {
            const grouping = $('#modalSalesGrouping').val();
            const salesGrouped = {};

            const formatDisplayDate = (isoDate, mode) => {
                const date = new Date(isoDate);
                const year = date.getFullYear();
                const month = date.toLocaleString('en-US', { month: 'short' });
                const day = String(date.getDate()).padStart(2, '0');
                const weekday = date.toLocaleString('en-US', { weekday: 'short' });

                if (mode === 'yearly') return `${year}`;
                if (mode === 'monthly') return `${month}/${year}`;
                return `${day}/${month}/${year}, ${weekday}`;
            };

            data.forEach(bill => {
                const dateObj = new Date(bill.billingDate);
                let key = bill.billingDate.split('T')[0];

                if (grouping === 'monthly')
                    key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                else if (grouping === 'yearly')
                    key = `${dateObj.getFullYear()}`;

                salesGrouped[key] = (salesGrouped[key] || 0) + bill.finalTotal;
            });

            const keys = Object.keys(salesGrouped).sort();
            const tbody = $('#modalSalesTable tbody').empty();

            let total = 0;
            keys.forEach((k, i) => {
                const val = salesGrouped[k];
                total += val;
                const display = formatDisplayDate(grouping === 'daily' ? k : k + '-01', grouping);
                tbody.append(`<tr><td>${i + 1}</td><td>${display}</td><td>${val.toFixed(2)}</td></tr>`);
            });

            const avg = total / keys.length || 0;
            $('#modalTotalSalesCell').text(`â‚¹ ${total.toFixed(2)}`);
            $('#modalAverageSalesCell').text(`â‚¹ ${avg.toFixed(2)}`);

            const labels = keys.map(k => formatDisplayDate(grouping === 'daily' ? k : k + '-01', grouping));
            const values = keys.map(k => salesGrouped[k]);

            const ctx = document.getElementById('modalSalesBarChart').getContext('2d');
            if (modalSalesChart) modalSalesChart.destroy();

            modalSalesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Total Sales',
                            data: values,
                            backgroundColor: 'rgba(10,47,79,0.8)',
                            borderColor: 'rgba(10,47,79)',
                            borderWidth: 1
                        },
                        {
                            label: 'Average',
                            data: new Array(values.length).fill(avg),
                            type: 'line',
                            borderColor: 'rgba(10,47,79)',
                            borderDash: [3, 3],
                            pointRadius: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    return ctx.dataset.label === 'Average'
                                        ? ` Average: â‚¹ ${ctx.raw.toFixed(2)}`
                                        : ` Total Sales: â‚¹ ${ctx.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Top Selling Products

        let tspViewMode = 'chart';

        function renderTopProductsChart(startDate, endDate) {
            const grouping = $('#tspGrouping').val();
            const query = { grouping };

            if (startDate && endDate) {
                query.startDate = startDate;
                query.endDate = endDate;
            }

            const queryString = new URLSearchParams(query).toString();

            fetch(`/top-selling-products?${queryString}`)
                .then(res => res.json())
                .then(data => {
                    const labels = data.map(p => p.name);
                    const quantities = data.map(p => p.quantity);

                    // Chart rendering
                    const ctx = document.getElementById('topProductsBarChart').getContext('2d');
                    if (window.topProductsChart) window.topProductsChart.destroy();

                    window.topProductsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Total Quantity Sold',
                                data: quantities,
                                backgroundColor: 'rgba(0, 42, 80, 0.8)',
                                borderColor: 'rgba(10, 47, 79, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ` Quantity: ${ctx.raw}`
                                    }
                                }
                            }
                        }
                    });

                    // Table rendering
                    const tbody = $('#tspTable tbody').empty();
                    data.forEach((p, i) => {
                        tbody.append(`
                    <tr>
                        <td>${i + 1}</td>
                        <td>${p.name}</td>
                        <td>${p.quantity}</td>
                    </tr>
                `);
                    });
                })
                .catch(err => {
                    console.error('Error fetching top products chart data:', err);
                });
        }

        function renderModalTopProductsChart(start, end, grouping) {
            const query = new URLSearchParams({ startDate: start, endDate: end, grouping }).toString();

            fetch(`/top-selling-products?${query}`)
                .then(res => res.json())
                .then(data => {
                    const labels = data.map(p => p.name);
                    const quantities = data.map(p => p.quantity);

                    // Render Chart
                    const ctx = document.getElementById('modalTopProductsBarChart').getContext('2d');
                    if (window.modalTopProductsChart) window.modalTopProductsChart.destroy();

                    window.modalTopProductsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Total Quantity Sold',
                                data: quantities,
                                backgroundColor: 'rgba(10, 47, 79, 0.8)',
                                borderColor: 'rgba(10, 47, 79, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ` Quantity: ${ctx.raw}`
                                    }
                                }
                            }
                        }
                    });

                    // Render Table
                    const tbody = $('#modalTspTable tbody').empty();
                    data.forEach((p, i) => {
                        tbody.append(`<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.quantity}</td></tr>`);
                    });
                })
                .catch(err => {
                    console.error('Error loading modal top products chart:', err);
                });
        }

        function syncTspModalViewWithMain() {
            if (tspViewMode === 'chart') {
                $('#modalTspChartContainer').removeClass('d-none');
                $('#modalTspTableContainer').addClass('d-none');
                $('#modalTspChartViewBtn').addClass('active');
                $('#modalTspTableViewBtn').removeClass('active');
            } else {
                $('#modalTspChartContainer').addClass('d-none');
                $('#modalTspTableContainer').removeClass('d-none');
                $('#modalTspChartViewBtn').removeClass('active');
                $('#modalTspTableViewBtn').addClass('active');
            }
        }

        $('#tspChartViewBtn').on('click', function () {
            tspViewMode = 'chart';
            $('#tspChartContainer').removeClass('d-none');
            $('#tspTableContainer').addClass('d-none');
            $('#tspChartViewBtn').addClass('active');
            $('#tspTableViewBtn').removeClass('active');
        });

        $('#tspTableViewBtn').on('click', function () {
            tspViewMode = 'table';
            $('#tspChartContainer').addClass('d-none');
            $('#tspTableContainer').removeClass('d-none');
            $('#tspChartViewBtn').removeClass('active');
            $('#tspTableViewBtn').addClass('active');
        });

        $('#tspApplyDateFilter').on('click', function () {
            const start = $('#tspStartDate').val();
            const end = $('#tspEndDate').val();

            if (!start || !end) {
                showToast('Please select both start and end dates.', 'text-bg-warning');
                return;
            }

            renderTopProductsChart(start, end);
        });

        $('#expandTspCardBtn').on('click', function () {
            const start = $('#tspStartDate').val();
            const end = $('#tspEndDate').val();
            const grouping = $('#tspGrouping').val();

            $('#modalTspStartDate').val(start);
            $('#modalTspEndDate').val(end);
            $('#modalTspGrouping').val(grouping);

            renderModalTopProductsChart(start, end, grouping);
            syncTspModalViewWithMain();

            const modal = new bootstrap.Modal(document.getElementById('tspFullscreenModal'));
            modal.show();

            setTimeout(() => {
                if (window.modalTopProductsChart) window.modalTopProductsChart.resize();
            }, 500);
        });

        $('#modalTspChartViewBtn').on('click', function () {
            tspViewMode = 'chart';
            $('#modalTspChartContainer').removeClass('d-none');
            $('#modalTspTableContainer').addClass('d-none');
            $('#modalTspChartViewBtn').addClass('active');
            $('#modalTspTableViewBtn').removeClass('active');

            // Sync main view
            $('#tspChartContainer').removeClass('d-none');
            $('#tspTableContainer').addClass('d-none');
            $('#tspChartViewBtn').addClass('active');
            $('#tspTableViewBtn').removeClass('active');
        });

        $('#modalTspTableViewBtn').on('click', function () {
            tspViewMode = 'table';
            $('#modalTspChartContainer').addClass('d-none');
            $('#modalTspTableContainer').removeClass('d-none');
            $('#modalTspChartViewBtn').removeClass('active');
            $('#modalTspTableViewBtn').addClass('active');

            // Sync main view
            $('#tspChartContainer').addClass('d-none');
            $('#tspTableContainer').removeClass('d-none');
            $('#tspChartViewBtn').removeClass('active');
            $('#tspTableViewBtn').addClass('active');
        });

        $('#modalTspApplyDateFilter').on('click', function () {
            const start = $('#modalTspStartDate').val();
            const end = $('#modalTspEndDate').val();
            const grouping = $('#modalTspGrouping').val();

            $('#tspStartDate').val(start);
            $('#tspEndDate').val(end);
            $('#tspGrouping').val(grouping);

            renderModalTopProductsChart(start, end, grouping);
            renderTopProductsChart(start, end);
        });

        $('#modalTspGrouping').on('change', function () {
            $('#modalTspApplyDateFilter').click();
        });

        // Product Distribution by Category

        let categoryViewMode = 'chart';

        function renderCategoryPieChart() {
            fetch('/product-category-distribution')
                .then(res => res.json())
                .then(data => {
                    const tbody = $('#categoryTableBody').empty();
                    const total = data.reduce((sum, c) => sum + c.count, 0);
                    data.forEach((c, i) => {
                        const percent = ((c.count / total) * 100).toFixed(1);
                        tbody.append(`
                            <tr>
                                <td>${i + 1}</td>
                                <td>${c.category}</td>
                                <td>${c.count}</td>
                                <td>${percent}%</td>
                            </tr>
                        `);
                    });

                    const labels = data.map(c => c.category);
                    const counts = data.map(c => c.count);
                    const colors = labels.map((_, i) => `rgba(10, 47, 79, ${1 - (i * 0.05)})`);

                    const ctx = document.getElementById('categoryPieChart').getContext('2d');
                    if (window.categoryChart) window.categoryChart.destroy();

                    window.categoryChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                borderColor: '#ffffff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top'
                                },
                                datalabels: {
                                    color: '#fff',
                                    formatter: (value, context) => {
                                        const data = context.chart.data.datasets[0].data;
                                        const total = data.reduce((sum, val) => sum + val, 0);
                                        const percent = ((value / total) * 100).toFixed(1);
                                        return `${percent}%`;
                                    },
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (ctx) {
                                            const label = ctx.label || '';
                                            const value = ctx.raw;
                                            return `${label}: ${value}`;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                })
                .catch(err => {
                    console.error('Error loading category pie chart:', err);
                });
        }

        function renderModalCategoryPieChart() {
            fetch('/product-category-distribution')
                .then(res => res.json())
                .then(data => {
                    const tbody = $('#modalCategoryTableBody').empty();
                    const total = data.reduce((sum, c) => sum + c.count, 0);
                    data.forEach((c, i) => {
                        const percent = ((c.count / total) * 100).toFixed(1);
                        tbody.append(`
                            <tr>
                                <td>${i + 1}</td>
                                <td>${c.category}</td>
                                <td>${c.count}</td>
                                <td>${percent}%</td>
                            </tr>
                        `);
                    });

                    const labels = data.map(c => c.category);
                    const counts = data.map(c => c.count);
                    const colors = labels.map((_, i) => `rgba(10, 47, 79, ${1 - (i * 0.05)})`);

                    const ctx = document.getElementById('modalCategoryPieChart').getContext('2d');
                    if (window.modalCategoryChart) window.modalCategoryChart.destroy();

                    window.modalCategoryChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                borderColor: '#ffffff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top'
                                },
                                datalabels: {
                                    color: '#fff',
                                    formatter: (value, context) => {
                                        const data = context.chart.data.datasets[0].data;
                                        const total = data.reduce((sum, val) => sum + val, 0);
                                        const percent = ((value / total) * 100).toFixed(1);
                                        return `${percent}%`;
                                    },
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (ctx) {
                                            const label = ctx.label || '';
                                            const value = ctx.raw;
                                            return `${label}: ${value}`;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                })
                .catch(err => {
                    console.error('Error loading modal category pie chart:', err);
                });
        }

        function syncCategoryViews() {
            if (categoryViewMode === 'chart') {
                $('#categoryChartContainer, #modalCategoryChartContainer').removeClass('d-none');
                $('#categoryTableContainer, #modalCategoryTableContainer').addClass('d-none');
                $('#categoryChartViewBtn, #modalCategoryChartViewBtn').addClass('active');
                $('#categoryTableViewBtn, #modalCategoryTableViewBtn').removeClass('active');
            } else {
                $('#categoryChartContainer, #modalCategoryChartContainer').addClass('d-none');
                $('#categoryTableContainer, #modalCategoryTableContainer').removeClass('d-none');
                $('#categoryChartViewBtn, #modalCategoryChartViewBtn').removeClass('active');
                $('#categoryTableViewBtn, #modalCategoryTableViewBtn').addClass('active');
            }
        }

        $('#categoryChartViewBtn').on('click', () => {
            categoryViewMode = 'chart';
            syncCategoryViews();
        });

        $('#categoryTableViewBtn').on('click', () => {
            categoryViewMode = 'table';
            syncCategoryViews();
        });

        $('#modalCategoryChartViewBtn').on('click', () => {
            categoryViewMode = 'chart';
            syncCategoryViews();
        });

        $('#modalCategoryTableViewBtn').on('click', () => {
            categoryViewMode = 'table';
            syncCategoryViews();
        });

        $('#expandCategoryChartBtn').on('click', function () {
            renderModalCategoryPieChart();
            const modal = new bootstrap.Modal(document.getElementById('categoryFullscreenModal'));
            modal.show();

            setTimeout(() => {
                if (window.modalCategoryChart) window.modalCategoryChart.resize();
            }, 500);
        });

        // Payment Mode Distribution

        let paymentViewMode = 'chart';

        function renderPaymentPieChart() {
            fetch('/mode-of-payments-distribution')
                .then(res => res.json())
                .then(data => {

                    const tbody = $('#paymentTableBody').empty();
                    const total = data.reduce((sum, p) => sum + p.count, 0);
                    data.forEach((p, i) => {
                        const percent = ((p.count / total) * 100).toFixed(1);
                        tbody.append(`
                            <tr>
                                <td>${i + 1}</td>
                                <td>${p.mode}</td>
                                <td>${p.count}</td>
                                <td>${percent}%</td>
                            </tr>
                        `);
                    });

                    const labels = data.map(p => p.mode);
                    const counts = data.map(p => p.count);
                    const colors = labels.map((_, i) => `rgba(10, 47, 79, ${0.9 - (i * 0.05)})`);

                    const ctx = document.getElementById('paymentPieChart').getContext('2d');
                    if (window.paymentChart) window.paymentChart.destroy();

                    window.paymentChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    color: '#fff',
                                    formatter: (value, ctx) => {
                                        const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return `${((value / total) * 100).toFixed(1)}%`;
                                    },
                                    font: { weight: 'bold' }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => `${ctx.label}: ${ctx.raw}`
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                })
                .catch(err => {
                    console.error('Error loading payment chart:', err);
                });
        }

        function renderModalPaymentPieChart() {
            fetch('/mode-of-payments-distribution')
                .then(res => res.json())
                .then(data => {

                    const tbody = $('#modalPaymentTableBody').empty();
                    const total = data.reduce((sum, p) => sum + p.count, 0);
                    data.forEach((p, i) => {
                        const percent = ((p.count / total) * 100).toFixed(1);
                        tbody.append(`
                            <tr>
                                <td>${i + 1}</td>
                                <td>${p.mode}</td>
                                <td>${p.count}</td>
                                <td>${percent}%</td>
                            </tr>
                        `);
                    });

                    const labels = data.map(p => p.mode);
                    const counts = data.map(p => p.count);
                    const colors = labels.map((_, i) => `rgba(10, 47, 79, ${0.9 - (i * 0.05)})`);

                    const ctx = document.getElementById('modalPaymentPieChart').getContext('2d');
                    if (window.modalPaymentChart) window.modalPaymentChart.destroy();

                    window.modalPaymentChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    color: '#fff',
                                    formatter: (value, ctx) => {
                                        const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return `${((value / total) * 100).toFixed(1)}%`;
                                    },
                                    font: { weight: 'bold' }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => `${ctx.label}: ${ctx.raw}`
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                })
                .catch(err => {
                    console.error('Error loading modal payment chart:', err);
                });
        }

        function syncPaymentViews() {
            if (paymentViewMode === 'chart') {
                $('#paymentChartContainer, #modalPaymentChartContainer').removeClass('d-none');
                $('#paymentTableContainer, #modalPaymentTableContainer').addClass('d-none');
                $('#paymentChartViewBtn, #modalPaymentChartViewBtn').addClass('active');
                $('#paymentTableViewBtn, #modalPaymentTableViewBtn').removeClass('active');
            } else {
                $('#paymentChartContainer, #modalPaymentChartContainer').addClass('d-none');
                $('#paymentTableContainer, #modalPaymentTableContainer').removeClass('d-none');
                $('#paymentChartViewBtn, #modalPaymentChartViewBtn').removeClass('active');
                $('#paymentTableViewBtn, #modalPaymentTableViewBtn').addClass('active');
            }
        }

        $('#paymentChartViewBtn').on('click', () => {
            paymentViewMode = 'chart';
            syncPaymentViews();
        });

        $('#paymentTableViewBtn').on('click', () => {
            paymentViewMode = 'table';
            syncPaymentViews();
        });

        $('#modalPaymentChartViewBtn').on('click', () => {
            paymentViewMode = 'chart';
            syncPaymentViews();
        });

        $('#modalPaymentTableViewBtn').on('click', () => {
            paymentViewMode = 'table';
            syncPaymentViews();
        });

        $('#expandPaymentChartBtn').on('click', function () {
            renderModalPaymentPieChart();
            const modal = new bootstrap.Modal(document.getElementById('paymentFullscreenModal'));
            modal.show();

            setTimeout(() => {
                if (window.modalCategoryChart) window.modalCategoryChart.resize();
            }, 500);
        });

        // Mode of Delivery Distribution

        let deliveryViewMode = 'chart';

        function renderDeliveryPieChart() {
            fetch('/mode-of-delivery-distribution')
                .then(res => res.json())
                .then(data => {

                    const tbody = $('#deliveryTableBody').empty();
                    const total = data.reduce((sum, d) => sum + d.count, 0);
                    data.forEach((d, i) => {
                        const percent = ((d.count / total) * 100).toFixed(1);
                        tbody.append(`
                            <tr>
                                <td>${i + 1}</td>
                                <td>${d.mode}</td>
                                <td>${d.count}</td>
                                <td>${percent}%</td>
                            </tr>
                        `);
                    });


                    const labels = data.map(d => d.mode);
                    const counts = data.map(d => d.count);
                    const colors = labels.map((_, i) => `rgba(10, 47, 79, ${0.85 - (i * 0.05)})`);

                    const ctx = document.getElementById('deliveryPieChart').getContext('2d');
                    if (window.deliveryChart) window.deliveryChart.destroy();

                    window.deliveryChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    color: '#fff',
                                    anchor: 'center',
                                    align: 'center',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    },
                                    formatter: (value, ctx) => {
                                        const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return `${((value / total) * 100).toFixed(1)}%`;
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => `${ctx.label}: ${ctx.raw}`
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                })
                .catch(err => {
                    console.error('Error loading delivery chart:', err);
                });
        }

        function renderModalDeliveryPieChart() {
            fetch('/mode-of-delivery-distribution')
                .then(res => res.json())
                .then(data => {

                    const tbody = $('#modalDeliveryTableBody').empty();
                    const total = data.reduce((sum, d) => sum + d.count, 0);
                    data.forEach((d, i) => {
                        const percent = ((d.count / total) * 100).toFixed(1);
                        tbody.append(`
                            <tr>
                                <td>${i + 1}</td>
                                <td>${d.mode}</td>
                                <td>${d.count}</td>
                                <td>${percent}%</td>
                            </tr>
                        `);
                    });

                    const labels = data.map(d => d.mode);
                    const counts = data.map(d => d.count);
                    const colors = labels.map((_, i) => `rgba(10, 47, 79, ${0.85 - (i * 0.05)})`);

                    const ctx = document.getElementById('modalDeliveryPieChart').getContext('2d');
                    if (window.modalDeliveryChart) window.modalDeliveryChart.destroy();

                    window.modalDeliveryChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    color: '#fff',
                                    anchor: 'center',
                                    align: 'center',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    },
                                    formatter: (value, ctx) => {
                                        const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return `${((value / total) * 100).toFixed(1)}%`;
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => `${ctx.label}: ${ctx.raw}`
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                })
                .catch(err => {
                    console.error('Error loading modal delivery chart:', err);
                });
        }

        function syncDeliveryViews() {
            if (deliveryViewMode === 'chart') {
                $('#deliveryChartContainer, #modalDeliveryChartContainer').removeClass('d-none');
                $('#deliveryTableContainer, #modalDeliveryTableContainer').addClass('d-none');
                $('#deliveryChartViewBtn, #modalDeliveryChartViewBtn').addClass('active');
                $('#deliveryTableViewBtn, #modalDeliveryTableViewBtn').removeClass('active');
            } else {
                $('#deliveryChartContainer, #modalDeliveryChartContainer').addClass('d-none');
                $('#deliveryTableContainer, #modalDeliveryTableContainer').removeClass('d-none');
                $('#deliveryChartViewBtn, #modalDeliveryChartViewBtn').removeClass('active');
                $('#deliveryTableViewBtn, #modalDeliveryTableViewBtn').addClass('active');
            }
        }

        $('#deliveryChartViewBtn').on('click', () => {
            deliveryViewMode = 'chart';
            syncDeliveryViews();
        });

        $('#deliveryTableViewBtn').on('click', () => {
            deliveryViewMode = 'table';
            syncDeliveryViews();
        });

        $('#modalDeliveryChartViewBtn').on('click', () => {
            deliveryViewMode = 'chart';
            syncDeliveryViews();
        });

        $('#modalDeliveryTableViewBtn').on('click', () => {
            deliveryViewMode = 'table';
            syncDeliveryViews();
        });

        $('#expandDeliveryChartBtn').on('click', function () {
            renderModalDeliveryPieChart();
            const modal = new bootstrap.Modal(document.getElementById('deliveryFullscreenModal'));
            modal.show();

            setTimeout(() => {
                if (window.modalCategoryChart) window.modalCategoryChart.resize();
            }, 500);
        });

        // Bill Count

        let billCountChart;

        let modalBillCountChart;
        let billCountViewMode = 'chart';

        function renderBillCountChart(startDate, endDate, grouping) {
            const filtered = allBills.filter(bill => {
                const date = bill.billingDate.split('T')[0];
                return date >= startDate && date <= endDate;
            });

            const grouped = {};
            filtered.forEach(bill => {
                const date = bill.billingDate.split('T')[0];
                let key = grouping === 'yearly' ? date.substr(0, 4)
                    : grouping === 'monthly' ? date.substr(0, 7)
                        : date;
                grouped[key] = (grouped[key] || 0) + 1;
            });

            const sortedKeys = Object.keys(grouped).sort();
            const labels = [], values = [];
            const tbody = $('#billCountTable tbody').empty();

            sortedKeys.forEach((k, i) => {
                const d = new Date(
                    grouping === 'yearly' ? `${k}-01-01` :
                        grouping === 'monthly' ? `${k}-01` : k
                );

                const display = grouping === 'yearly'
                    ? d.getFullYear()
                    : grouping === 'monthly'
                        ? `${d.toLocaleString('default', { month: 'short' })} ${d.getFullYear()}`
                        : `${String(d.getDate()).padStart(2, '0')}/${d.toLocaleString('default', { month: 'short' })}/${d.getFullYear()}, ${d.toLocaleString('default', { weekday: 'short' })}`;

                labels.push(display);
                values.push(grouped[k]);

                // Append table row
                tbody.append(`
                    <tr>
                        <td>${i + 1}</td>
                        <td>${display}</td>
                        <td>${grouped[k]}</td>
                    </tr>
                `);
            });

            const total = values.reduce((sum, v) => sum + v, 0);
            const average = values.length ? (total / values.length) : 0;

            $('#billCountTotalCell').text(total);
            $('#billCountAverageCell').text(average.toFixed(2));

            const ctx = document.getElementById('billCountLineChart').getContext('2d');
            if (billCountChart) billCountChart.destroy();

            billCountChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Number of Bills',
                        data: values,
                        borderColor: 'rgba(10, 47, 79, 0.8)',
                        borderWidth: 2,
                        backgroundColor: 'rgba(10, 47, 79, 0.2)',
                        tension: 0,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderModalBillCountChart() {
            const start = $('#modalBillCountStart').val();
            const end = $('#modalBillCountEnd').val();
            const grouping = $('#modalBillCountGrouping').val();

            const filtered = allBills.filter(b => {
                const d = b.billingDate.split('T')[0];
                return d >= start && d <= end;
            });

            const grouped = {};
            filtered.forEach(b => {
                const d = b.billingDate.split('T')[0];
                const key = grouping === 'yearly' ? d.substr(0, 4) :
                    grouping === 'monthly' ? d.substr(0, 7) : d;
                grouped[key] = (grouped[key] || 0) + 1;
            });

            const keys = Object.keys(grouped).sort();
            const labels = [], values = [];
            const tbody = $('#modalBillCountTable tbody').empty();

            keys.forEach((k, i) => {
                const d = new Date(grouping === 'yearly' ? `${k}-01-01` :
                    grouping === 'monthly' ? `${k}-01` : k);
                const label = grouping === 'yearly'
                    ? d.getFullYear()
                    : grouping === 'monthly'
                        ? `${d.toLocaleString('default', { month: 'short' })} ${d.getFullYear()}`
                        : `${String(d.getDate()).padStart(2, '0')}/${d.toLocaleString('default', { month: 'short' })}/${d.getFullYear()}, ${d.toLocaleString('default', { weekday: 'short' })}`;

                labels.push(label);
                values.push(grouped[k]);
                tbody.append(`<tr><td>${i + 1}</td><td>${label}</td><td>${grouped[k]}</td></tr>`);
            });

            const total = values.reduce((a, b) => a + b, 0);
            const avg = values.length ? total / values.length : 0;

            $('#modalBillCountTotalCell').text(total);
            $('#modalBillCountAverageCell').text(avg.toFixed(2));

            const ctx = document.getElementById('modalBillCountChart').getContext('2d');
            if (modalBillCountChart) modalBillCountChart.destroy();

            modalBillCountChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Number of Bills',
                        data: values,
                        borderColor: 'rgba(10, 47, 79, 0.8)',
                        borderWidth: 2,
                        backgroundColor: 'rgba(10, 47, 79, 0.2)',
                        tension: 0,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        $('#billCountGrouping').on('change', function () {
            const start = $('#billCountStart').val();
            const end = $('#billCountEnd').val();
            const grouping = $(this).val();

            if (!start || !end) return showToast('Select both start and end dates.', 'text-bg-warning');

            renderBillCountChart(start, end, grouping);
        });

        $('#applyBillCountFilter').on('click', function () {
            const start = $('#billCountStart').val();
            const end = $('#billCountEnd').val();
            const grouping = $('#billCountGrouping').val();

            if (!start || !end) return showToast('Select both start and end dates.', 'text-bg-warning');

            renderBillCountChart(start, end, grouping);
        });

        $('#billCountChartViewBtn').on('click', function () {
            billCountViewMode = 'chart';

            // Show chart in card
            $('#billCountChartContainer').removeClass('d-none');
            $('#billCountTableContainer').addClass('d-none');
            $('#billCountChartViewBtn').addClass('active');
            $('#billCountTableViewBtn').removeClass('active');

            // Show chart in modal (if open)
            $('#modalBillCountChartContainer').removeClass('d-none');
            $('#modalBillCountTableContainer').addClass('d-none');
            $('#modalBillCountChartViewBtn').addClass('active');
            $('#modalBillCountTableViewBtn').removeClass('active');
        });

        $('#billCountTableViewBtn').on('click', function () {
            billCountViewMode = 'table';

            $('#billCountChartContainer').addClass('d-none');
            $('#billCountTableContainer').removeClass('d-none');
            $('#billCountChartViewBtn').removeClass('active');
            $('#billCountTableViewBtn').addClass('active');

            $('#modalBillCountChartContainer').addClass('d-none');
            $('#modalBillCountTableContainer').removeClass('d-none');
            $('#modalBillCountChartViewBtn').removeClass('active');
            $('#modalBillCountTableViewBtn').addClass('active');
        });

        // Expand button handler
        $('#expandBillCountCardBtn').on('click', function () {
            // Sync controls
            $('#modalBillCountStart').val($('#billCountStart').val());
            $('#modalBillCountEnd').val($('#billCountEnd').val());
            $('#modalBillCountGrouping').val($('#billCountGrouping').val());

            // Render in modal
            renderModalBillCountChart();
            syncModalBillCountViewWithMain();

            const modal = new bootstrap.Modal('#billCountFullscreenModal');
            modal.show();

            setTimeout(() => {
                if (modalBillCountChart) modalBillCountChart.resize();
            }, 300);
        });

        // Sync view buttons
        function syncModalBillCountViewWithMain() {
            if (billCountViewMode === 'chart') {
                $('#modalBillCountChartContainer').removeClass('d-none');
                $('#modalBillCountTableContainer').addClass('d-none');
                $('#modalBillCountChartViewBtn').addClass('active');
                $('#modalBillCountTableViewBtn').removeClass('active');
            } else {
                $('#modalBillCountChartContainer').addClass('d-none');
                $('#modalBillCountTableContainer').removeClass('d-none');
                $('#modalBillCountChartViewBtn').removeClass('active');
                $('#modalBillCountTableViewBtn').addClass('active');
            }
        }

        // View toggle buttons
        $('#modalBillCountChartViewBtn').on('click', function () {
            billCountViewMode = 'chart';

            // Modal
            $('#modalBillCountChartContainer').removeClass('d-none');
            $('#modalBillCountTableContainer').addClass('d-none');
            $('#modalBillCountChartViewBtn').addClass('active');
            $('#modalBillCountTableViewBtn').removeClass('active');

            // Card
            $('#billCountChartContainer').removeClass('d-none');
            $('#billCountTableContainer').addClass('d-none');
            $('#billCountChartViewBtn').addClass('active');
            $('#billCountTableViewBtn').removeClass('active');
        });

        $('#modalBillCountTableViewBtn').on('click', function () {
            billCountViewMode = 'table';

            $('#modalBillCountChartContainer').addClass('d-none');
            $('#modalBillCountTableContainer').removeClass('d-none');
            $('#modalBillCountChartViewBtn').removeClass('active');
            $('#modalBillCountTableViewBtn').addClass('active');

            $('#billCountChartContainer').addClass('d-none');
            $('#billCountTableContainer').removeClass('d-none');
            $('#billCountChartViewBtn').removeClass('active');
            $('#billCountTableViewBtn').addClass('active');
        });

        // Apply button
        $('#modalBillCountApply').on('click', function () {
            const start = $('#modalBillCountStart').val();
            const end = $('#modalBillCountEnd').val();
            const grouping = $('#modalBillCountGrouping').val();

            $('#billCountStart').val(start);
            $('#billCountEnd').val(end);
            $('#billCountGrouping').val(grouping);

            renderBillCountChart(start, end, grouping);
            renderModalBillCountChart();
        });

        // Grouping change
        $('#modalBillCountGrouping').on('change', function () {
            $('#modalBillCountApply').click();
        });

        // Reusable Toast Function

        function showToast(message, bgColorClass = 'text-bg-primary') {
            const toastEl = document.getElementById('mainToast');
            const toastBody = document.getElementById('mainToastBody');

            toastEl.className = `toast align-items-center ${bgColorClass} border-0`;
            toastBody.textContent = message;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

    </script>
</body>

</html>