<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inventurax | Billing</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/lightTheme.css">
    <link rel="stylesheet" href="css/material-font-icons.css">
</head>

<body>

    <div class="d-flex" id="wrapper">

        <!-- Sidebar -->
        <div class="shadow-sm" id="sidebar-wrapper">
            <div class="sidebar-heading p-3 d-flex justify-content-between align-items-center">
                <img id="sidebarLogoFull" src="images/inventuraxLogoWhite.png" alt="Full Logo" class="img-fluid">
                <img id="sidebarLogoIcon" src="images/inventuraxIconWhite.png" alt="Icon Logo" class="img-fluid d-none">
            </div>

            <!-- Scrollable content wrapper -->
            <div class="sidebar-content">
                <div class="list-group list-group-flush flex-grow-1">
                    <a href="/dashboard" class="list-group-item list-group-item-sidebar" title="Dashboard">
                        <i class="gsymbols-round gicon-home fs-5"></i><span class="link-text">Dashboard</span>
                    </a>
                    <a href="/productlisting" class="list-group-item list-group-item-sidebar" title="Product Listing">
                        <i class="gsymbols-round gicon-inventory fs-5"></i><span class="link-text">Product
                            Listing</span>
                    </a>
                    <a class="list-group-item list-group-item-sidebar active" title="Billing">
                        <i class="gsymbols-round gicon-receipt_long fs-5"></i><span class="link-text">Billing</span>
                    </a>
                    <a href="/billlogs" class="list-group-item list-group-item-sidebar" title="Bill Logs">
                        <i class="gsymbols-round gicon-auto_stories fs-5"></i><span class="link-text">Bill Logs</span>
                    </a>
                    <a href="/analytics" class="list-group-item list-group-item-sidebar" title="Analytics">
                        <i class="gsymbols-round gicon-insights fs-5"></i><span class="link-text">Analytics</span>
                    </a>
                    <a href="/customers" class="list-group-item list-group-item-sidebar" title="Customers">
                        <i class="gsymbols-round gicon-group fs-5"></i><span class="link-text">Customers</span>
                    </a>
                </div>
            </div>

            <!-- Bottom Toggle Button -->
            <div class="text-center p-3 sidebar-toggle-wrapper">
                <button class="btn btn-outline-light w-100" id="toggleSidebar">
                    <i class="gsymbols-round gicon-chevron_left" id="toggleIcon"></i>
                </button>
            </div>
        </div>

        <!-- Main Page content -->
        <div id="mainPageContent" class="p-4 flex-grow-1">

            <!-- Header Section -->
            <div class="container-fluid d-flex justify-content-between">
                <div class="gap-2">
                    <button type="button" class="btn btn-darkblue btn-sm" id="saveBillBtn">Save Bill</button>
                    <button type="button" class="btn btn-darkblue2 btn-sm" id="generateBillBtn">Generate Bill</button>
                    <button type="button" class="btn btn-whatsapp btn-sm" id="whatsappBtn">Open WhatsApp</button>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <div class="input-group input-group-sm w-50">
                        <span class="input-group-text bg-darkblue text-light" id="inputGroup-sizing-sm">Bill No.</span>
                        <input type="text" class="form-control text-center" id="billNumber" disabled>
                    </div>
                    <div class="dropdown profileButton">
                        <button class="btn btn-sm btn-darkblue dropdown-toggle" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Username
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item dropdown-item-signout" href="/logout">Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="container-fluid my-3">
                <div class="row">
                    <div class="col-lg-2 mb-3">
                        <label for="customerName" class="form-label small">Customer Name</label>
                        <input id="customerName" type="text" class="form-control form-control-sm bg-transparent">
                    </div>
                    <div class="col-lg-2 mb-3">
                        <label for="customerNumber" class="form-label small">Contact Number</label>
                        <input class="form-control form-control-sm bg-transparent" type="text" id="customerNumber">
                    </div>
                    <div class="col-lg-2 mb-3">
                        <label for="billingDate" class="form-label small">Billing Date</label>
                        <input class="form-control form-control-sm bg-transparent" type="date" id="billingDate">
                    </div>
                    <div class="col-lg-2 mb-3">
                        <label for="billingTime" class="form-label small">Billing Time</label>
                        <input class="form-control form-control-sm bg-transparent" type="time" id="billingTime">
                    </div>
                    <div class="col-lg-2 mb-3">
                        <label for="modeOfDelivery" class="form-label small">Mode of Delivery</label>
                        <select class="form-select form-select-sm bg-transparent" id="modeOfDelivery">
                            <option value="In-house" selected>In-house</option>
                            <option value="Home Delivery">Home Delivery</option>
                        </select>
                    </div>
                    <div class="col-lg-2 mb-3">
                        <label for="modeOfPayment" class="form-label small">Mode of Payment</label>
                        <select class="form-select form-select-sm bg-transparent" id="modeOfPayment">
                            <option value="Cash" selected>Cash</option>
                            <option value="Online">Online</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Debit">Debit</option>
                        </select>
                    </div>
                    <div class="col-lg-12 mb-3" id="addressContainer">
                        <label for="customerAddress" class="form-label small">Address</label>
                        <input class="form-control form-control-sm bg-transparent" type="text" id="customerAddress">
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-5 mb-3 position-relative">
                        <label for="productName" class="form-label small">Product Name</label>
                        <input class="form-control form-control-sm bg-transparent" type="text" id="productName"
                            autocomplete="off">
                    </div>
                    <div class="col-lg-4 mb-3">
                        <label for="productQuantity" class="form-label small">Quantity</label>
                        <input class="form-control form-control-sm bg-transparent" type="number" min="1" value="1"
                            id="productQuantity">
                    </div>
                    <div class="col-lg-3 mb-3 d-flex align-items-center">
                        <button class="btn btn-darkblue w-100 h-100" id="addProductBtn">Add Product</button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card border-1" id="productTableCard">
                            <table class="table table-sm table-bordered align-middle text-center" id="productTable">
                                <thead>
                                    <tr>
                                        <th class="w-25 align-middle">Product Name</th>
                                        <th class="w-10 align-middle">Quantity</th>
                                        <th class="w-10 align-middle">Price (per unit)</th>
                                        <th class="w-10 align-middle">Total</th>
                                        <th class="w-10 align-middle">Discount (%)</th>
                                        <th class="w-25 align-middle">Discounted Total</th>
                                        <th class="w-10 align-middle">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="noProductRow">
                                        <td colspan="7" class="text-muted align-middle">No Product Selected</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-center fw-bold bg-transparent align-middle">Total
                                        </td>
                                        <td class="text-center fw-bold bg-transparent align-middle" id="grandTotalCell">
                                            0.00</td>
                                        <td class="bg-transparent align-middle"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-center fw-bold bg-transparent align-middle">Overall
                                            Discount (%)
                                        </td>
                                        <td class="text-center bg-transparent align-middle">
                                            <input type="number" id="overallDiscountInput"
                                                class="form-control form-control-sm text-center fw-bold bg-transparent"
                                                min="0" max="100" value="0">
                                        </td>
                                        <td class="bg-transparent align-middle"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-center fw-bold bg-transparent align-middle">Final
                                            Total (After
                                            Discount)</td>
                                        <td class="text-center bg-transparent align-middle">
                                            <input type="number" id="finalTotalInput"
                                                class="form-control form-control-sm text-center fw-bold bg-transparent"
                                                min="0" step="0.01" value="0.00">
                                        </td>
                                        <td class="bg-transparent align-middle"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Section -->
            <footer class="mt-auto pt-3 border-top text-center small text-muted">
                <div class="container">
                    &copy; 2025 Inventurax. All rights reserved. | Version 1.0.0
                </div>
            </footer>

        </div>
    </div>

    <!-- Modal -->

    <!-- Duplicate Product Modal -->
    <div class="modal fade" id="duplicateProductModal" tabindex="-1" aria-labelledby="duplicateProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateProductModalLabel">Duplicate Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    You already have "<span id="duplicateProductName" class="fw-bold"></span>" in your cart. Would you
                    like to add the quantity to the existing one?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-darkblue" id="confirmAddDuplicate">Yes, Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Bill Confirmation Modal -->
    <div class="modal fade" id="saveConfirmModal" tabindex="-1" aria-labelledby="saveConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveConfirmModalLabel">Confirm Save</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save this bill?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-darkblue btn-sm" id="confirmSaveBtn">Yes, Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="mainToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="mainToastBody">
                    <!-- Message goes here -->
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- <iframe id="pdfIframe" style="width:100%; height:600px; border:1px solid #ccc;"></iframe> -->

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/jspdf.umd.min.js"></script>
    <script src="js/jspdf.plugin.autotable.min.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/qrcode.min.js"></script>
    <script>
        // Session check
        fetch('/session-check')
            .then(res => res.json())
            .then(data => {
                if (!data.loggedIn) {
                    window.location.href = '/';
                } else {
                    document.querySelector('.profileButton .dropdown-toggle').textContent = data.username;
                }
            })
            .catch(() => {
                window.location.href = '/';
            });

        $(document).ready(function () {

            // Fetch Next Bill Number

            fetch('/next-bill-number')
                .then(res => res.json())
                .then(data => {
                    if (data.nextBillNumber) {
                        $('#billNumber').val(data.nextBillNumber);
                    }
                })
                .catch(() => {
                    showToast('Failed to fetch bill number', 'text-bg-danger');
                });

            // Open WhatsApp Profile

            $('.btn-whatsapp').on('click', function () {
                const number = $('#customerNumber').val().trim();

                if (!/^\d{10}$/.test(number)) {
                    showToast('Please enter a valid 10-digit Contact Number', 'text-bg-danger');
                    return;
                }

                const fullNumber = '91' + number;
                const whatsappURL = `https://wa.me/${fullNumber}`;

                window.open(whatsappURL, '_blank');
            });

            // Address Field Toggle based on Mode of Delivery

            function toggleAddressField() {
                const deliveryMode = $('#modeOfDelivery').val();
                if (deliveryMode === 'Home Delivery') {
                    $('#addressContainer').show();
                } else {
                    $('#addressContainer').hide();
                }
            }

            $('#modeOfDelivery').on('change', toggleAddressField);
            toggleAddressField();

            // Prefill Date and Time

            const now = new Date();

            const dateStr = now.toISOString().split('T')[0];
            $('#billingDate').val(dateStr);

            const timeStr = now.toTimeString().slice(0, 5);
            $('#billingTime').val(timeStr);

            // Autocomplete for Product Name

            $('#productName').on('input', function () {
                const query = $(this).val();
                if (query.length < 1) {
                    $('#productNameDropdown').remove();
                    return;
                }

                $.get(`/search-products?q=${encodeURIComponent(query)}`, function (data) {
                    let dropdown = $('#productNameDropdown');
                    if (dropdown.length === 0) {
                        dropdown = $('<div id="productNameDropdown" class="dropdown-menu py-1 dropdown-menu-sm show"></div>');
                        $('#productName').after(dropdown);
                    }

                    dropdown.empty();
                    if (data.length === 0) {
                        dropdown.append('<span class="dropdown-item text-muted">No results</span>');
                        return;
                    }

                    data.forEach(product => {

                        nameFilter = document.getElementById("productName").value;

                        const highlightMatch = (text, searchTerm) => {
                            if (!searchTerm) return text;
                            const regex = new RegExp(`(${searchTerm})`, 'gi');
                            return text.replace(regex, '<span class="highlightedTextDropdown">$1</span>');
                        };

                        const item = $(`<button class="dropdown-item" type="button">${highlightMatch(product.name, nameFilter)}</button>`);
                        item.on('click', function () {
                            $('#productName').val(product.name);
                            dropdown.remove();
                        });
                        dropdown.append(item);
                    });
                });
            });

            // Hide dropdown if clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#productName').length) {
                    $('#productNameDropdown').remove();
                }
            });

            $('#productTable tbody').on('click', '.delete-row', function () {
                $(this).closest('tr').remove();
                toggleNoProductRow();
                updateGrandTotal();
            });

            let pendingProduct = null;

            $('#addProductBtn').on('click', function () {
                const productName = $('#productName').val().trim();
                const quantity = parseFloat($('#productQuantity').val().trim());

                if (!productName || isNaN(quantity) || quantity <= 0) {
                    showToast('Please enter valid product and quantity', 'text-bg-danger');
                    return;
                }

                // Fetch product details from server
                $.get(`/search-products?q=${encodeURIComponent(productName)}`, function (products) {
                    const product = products.find(p => p.name.toLowerCase() === productName.toLowerCase());
                    if (!product) {
                        showToast('Product not found', 'text-bg-danger');
                        return;
                    }

                    // Check if product already exists in table
                    const existingRow = $('#productTable tbody tr').not('#noProductRow').filter(function () {
                        return $(this).find('td:first').text().trim().toLowerCase() === product.name.toLowerCase();
                    });

                    if (existingRow.length) {
                        pendingProduct = { name: product.name, price: product.price, quantity: quantity, row: existingRow };
                        $('#duplicateProductName').text(product.name);
                        new bootstrap.Modal(document.getElementById('duplicateProductModal')).show();
                        return;
                    }

                    // If product does not exist, add as new row
                    addProductRow(product.name, quantity, product.price);
                });
            });

            // Handle confirmation modal "Yes, Add"
            $('#confirmAddDuplicate').on('click', function () {
                if (pendingProduct && pendingProduct.row) {
                    const row = pendingProduct.row;
                    const quantityInput = row.find('.quantity-input');
                    const currentQty = parseFloat(quantityInput.val());
                    const newQty = currentQty + pendingProduct.quantity;

                    quantityInput.val(newQty);
                    quantityInput.trigger('input');
                }

                bootstrap.Modal.getInstance(document.getElementById('duplicateProductModal')).hide();
                pendingProduct = null;

                $('#productName').val('');
                $('#productQuantity').val(1);
            });

            function addProductRow(name, quantity, price) {
                const total = quantity * price;
                const discountedTotal = total;

                const row = `
                    <tr>
                        <td class="product-name">${name}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm quantity-input text-center" min="1" value="${quantity}">
                        </td>
                        <td class="unit-price">${price.toFixed(2)}</td>
                        <td class="original-total">${total.toFixed(2)}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm discount-input text-center" min="0" max="100" value="0">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm discounted-total-input text-center" min="0" value="${discountedTotal.toFixed(2)}">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-row w-100">
                                <i class="gsymbols-round gicon-delete"></i>
                            </button>
                        </td>
                    </tr>
                `;

                $('#productTable tbody').append(row);
                toggleNoProductRow();
                updateGrandTotal();

                $('#productName').val('');
                $('#productQuantity').val(1);
            }

            $('#productTable tbody').on('input', '.discount-input', function () {
                const discount = parseFloat($(this).val());
                const row = $(this).closest('tr');

                const originalTotal = parseFloat(row.find('.original-total').text());

                if (isNaN(discount) || discount < 0 || discount > 100) {
                    row.find('.discounted-total').text(originalTotal.toFixed(2));
                    return;
                }

                const discountedPrice = originalTotal * (1 - discount / 100);
                row.find('.discounted-total').text(discountedPrice.toFixed(2));
                updateGrandTotal();
            });

            $('#productTable tbody').on('input', '.quantity-input, .discount-input', function () {
                const row = $(this).closest('tr');

                const quantity = parseFloat(row.find('.quantity-input').val());
                const price = parseFloat(row.find('.unit-price').text());
                const discount = parseFloat(row.find('.discount-input').val());

                if (isNaN(quantity) || quantity <= 0) return;
                if (isNaN(price)) return;

                const originalTotal = quantity * price;
                row.find('.original-total').text(originalTotal.toFixed(2));

                let discounted = originalTotal;
                if (!isNaN(discount) && discount >= 0 && discount <= 100) {
                    discounted = originalTotal * (1 - discount / 100);
                }

                row.find('.discounted-total-input').val(discounted.toFixed(2));
                updateGrandTotal();
            });

            // When Discounted Total is changed manually, update Discount %
            $('#productTable tbody').on('input', '.discounted-total-input', function () {
                const row = $(this).closest('tr');

                const discountedTotal = parseFloat($(this).val());
                const quantity = parseFloat(row.find('.quantity-input').val());
                const price = parseFloat(row.find('.unit-price').text());

                if (isNaN(discountedTotal) || isNaN(quantity) || isNaN(price) || quantity <= 0) return;

                const originalTotal = quantity * price;
                row.find('.original-total').text(originalTotal.toFixed(2));

                let discountPercent = 0;
                if (discountedTotal < originalTotal) {
                    discountPercent = ((1 - (discountedTotal / originalTotal)) * 100);
                }

                row.find('.discount-input').val(discountPercent.toFixed(2));
                updateGrandTotal();
            });

            function toggleNoProductRow() {
                const hasRows = $('#productTable tbody tr').not('#noProductRow').length > 0;
                $('#noProductRow').toggle(!hasRows);
            }

            function updateGrandTotal() {
                let total = 0;

                $('#productTable tbody tr').not('#noProductRow').each(function () {
                    const discountedInput = $(this).find('.discounted-total-input');
                    if (discountedInput.length) {
                        const value = parseFloat(discountedInput.val());
                        if (!isNaN(value)) total += value;
                    }
                });

                $('#grandTotalCell').text(total.toFixed(2));

                // Apply overall discount if any
                const overallDiscount = parseFloat($('#overallDiscountInput').val());
                let finalTotal = total;

                if (!isNaN(overallDiscount) && overallDiscount >= 0 && overallDiscount <= 100) {
                    finalTotal = total * (1 - overallDiscount / 100);
                }

                $('#finalTotalInput').val(finalTotal.toFixed(2));
            }

            // When user edits Final Total, recalculate Overall Discount
            $('#finalTotalInput').on('input', function () {
                const finalTotal = parseFloat($(this).val());
                const grandTotal = parseFloat($('#grandTotalCell').text());

                if (!isNaN(finalTotal) && grandTotal > 0) {
                    let overallDiscount = 0;
                    if (finalTotal < grandTotal) {
                        overallDiscount = ((1 - (finalTotal / grandTotal)) * 100);
                    }
                    $('#overallDiscountInput').val(overallDiscount.toFixed(2));
                }
            });

            $('#overallDiscountInput').on('input', function () {
                updateGrandTotal();
            });

            $('#saveBillBtn').on('click', function () {
                const hasProducts = $('#productTable tbody tr').not('#noProductRow').length > 0;

                if (!hasProducts) {
                    showToast('Please enter items into cart', 'text-bg-danger');
                    return;
                }

                const modeOfDelivery = $('#modeOfDelivery').val();
                const customerName = $('#customerName').val().trim();
                const customerNumber = $('#customerNumber').val().trim();
                const customerAddress = $('#customerAddress').val().trim();

                if (modeOfDelivery === 'Home Delivery') {
                    if (!customerName || !customerNumber || !customerAddress) {
                        showToast('Please fill Customer Name, Contact Number, and Address for Home Delivery', 'text-bg-danger');
                        return;
                    }

                    if (!/^\d{10}$/.test(customerNumber)) {
                        showToast('Contact Number must be exactly 10 digits', 'text-bg-danger');
                        return;
                    }
                }

                new bootstrap.Modal(document.getElementById('saveConfirmModal')).show();
            });

            $('#confirmSaveBtn').on('click', function () {
                const products = [];

                $('#productTable tbody tr').not('#noProductRow').each(function () {
                    const row = $(this);
                    const name = row.find('td:first').text().trim();
                    const quantity = parseFloat(row.find('.quantity-input').val());
                    const unitPrice = parseFloat(row.find('.unit-price').text());
                    const originalTotal = parseFloat(row.find('.original-total').text());
                    const discount = parseFloat(row.find('.discount-input').val());
                    const discountedTotal = parseFloat(row.find('.discounted-total-input').val());

                    if (name && !isNaN(quantity)) {
                        products.push({ name, quantity, unitPrice, originalTotal, discount, discountedTotal });
                    }
                });

                const modeOfDelivery = $('#modeOfDelivery').val();
                const customerName = $('#customerName').val().trim();
                const customerNumber = $('#customerNumber').val().trim();
                const customerAddress = $('#customerAddress').val().trim();

                if (modeOfDelivery === 'Home Delivery') {
                    if (!customerName || !customerNumber || !customerAddress) {
                        showToast('Please fill Customer Name, Contact Number, and Address for Home Delivery', 'text-bg-danger');
                        return;
                    }
                }

                const billData = {
                    billNumber: parseInt($('#billNumber').val()),
                    customerName: $('#customerName').val().trim() || "Unknown",
                    customerNumber: $('#customerNumber').val().trim() || "0000000000",
                    billingDate: $('#billingDate').val(),
                    billingTime: $('#billingTime').val(),
                    modeOfDelivery: $('#modeOfDelivery').val(),
                    modeOfPayment: $('#modeOfPayment').val(),
                    customerAddress: $('#customerAddress').val().trim() || "Unknown",
                    products: products,
                    overallTotal: parseFloat($('#grandTotalCell').text()),
                    overallDiscount: parseFloat($('#overallDiscountInput').val()) || 0,
                    finalTotal: parseFloat($('#finalTotalInput').val())
                };

                $.ajax({
                    url: '/save-bill',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(billData),
                    success: function (response) {

                        bootstrap.Modal.getInstance(document.getElementById('saveConfirmModal')).hide();

                        showToast('Bill saved successfully!', 'text-bg-success');

                        // Remove Existing Items from Cart
                        $('#productTable tbody tr').not('#noProductRow').remove();

                        // Show no Product Row
                        $('#noProductRow').show();

                        // Reset Values
                        $('#customerName').val('');
                        $('#customerNumber').val('');
                        $('#customerAddress').val('');
                        const now = new Date();
                        const dateStr = now.toISOString().split('T')[0];
                        $('#billingDate').val(dateStr);
                        const timeStr = now.toTimeString().slice(0, 5);
                        $('#billingTime').val(timeStr);
                        $('#modeOfDelivery').val("In-house");
                        $('#modeOfPayment').val("Cash");
                        $('#grandTotalCell').text('0.00');
                        $('#overallDiscountInput').val(0);
                        $('#finalTotalInput').val('0.00');

                        $('#productName').val('');
                        $('#productQuantity').val(1);

                        if (response.billNumber) {
                            $('#billNumber').val(response.billNumber + 1);
                        } else {
                            fetch('/next-bill-number')
                                .then(res => res.json())
                                .then(data => $('#billNumber').val(data.nextBillNumber));
                        }
                    },
                    error: function () {
                        showToast('Failed to save bill', 'text-bg-danger');
                    }
                });
            });

            $('#customerNumber').on('input', function () {
                this.value = this.value.replace(/\D/g, '');

                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
            });

            function setupCustomerAutocomplete(inputId, isNameInput) {
                $(`#${inputId}`).on('input', function () {
                    const query = $(this).val().trim();
                    if (query.length < 1) {
                        $(`#${inputId}Dropdown`).remove();
                        return;
                    }

                    $.get(`/search-customers?q=${encodeURIComponent(query)}`, function (data) {
                        let dropdown = $(`#${inputId}Dropdown`);
                        if (dropdown.length === 0) {
                            dropdown = $('<div>', {
                                id: `${inputId}Dropdown`,
                                class: 'dropdown-menu dropdown-menu-sm py-1 show',
                                css: {
                                    position: 'absolute',
                                    top: $(`#${inputId}`).position().top + $(`#${inputId}`).outerHeight(),
                                    left: $(`#${inputId}`).position().left,
                                    width: $(`#${inputId}`).outerWidth(),
                                    zIndex: 9999
                                }
                            });
                            $(`#${inputId}`).after(dropdown);
                        }

                        dropdown.empty();

                        if (data.length === 0) {
                            dropdown.append('<span class="dropdown-item text-muted">No results</span>');
                            return;
                        }

                        data.forEach(item => {

                            const highlightMatch = (text, searchTerm) => {
                                if (!searchTerm) return text;
                                const regex = new RegExp(`(${searchTerm})`, 'gi');
                                return text.replace(regex, '<span class="highlightedTextDropdown">$1</span>');
                            };

                            const labelRaw = isNameInput ? item.name : item.number;
                            const labelHighlighted = highlightMatch(labelRaw, query);
                            const btn = $(`<button class="dropdown-item" type="button">${labelHighlighted}</button>`);

                            btn.on('click', () => {
                                $('#customerName').val(item.name);
                                $('#customerNumber').val(item.number);
                                $('#customerAddress').val(item.address || '');
                                dropdown.remove();
                            });
                            dropdown.append(btn);
                        });
                    });
                });

                // Remove dropdown if clicked outside
                $(document).on('click', function (e) {
                    if (!$(e.target).closest(`#${inputId}`).length) {
                        $(`#${inputId}Dropdown`).remove();
                    }
                });
            }

            // Call for both inputs
            setupCustomerAutocomplete('customerName', true);  // name input
            setupCustomerAutocomplete('customerNumber', false); // number input

        });

        // Reusable Toast Function
        function showToast(message, bgColorClass = 'text-bg-primary') {
            const toastEl = document.getElementById('mainToast');
            const toastBody = document.getElementById('mainToastBody');

            toastEl.className = `toast align-items-center ${bgColorClass} border-0`;
            toastBody.textContent = message;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        document.getElementById('generateBillBtn').addEventListener('click', async function () {

            const hasProducts = $('#productTable tbody tr').not('#noProductRow').length > 0;

            if (!hasProducts) {
                showToast('Please enter items into cart', 'text-bg-danger');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const iconSize = 6;
            const iconY = 5;
            const textYOffset = 4;
            const spacing = 4;
            const columnGap = 113;
            const leftMargin = 10;

            // Fetch YouTube icon
            const youtubeIcon = await fetch('images/youtubeLogo.png')
                .then(res => res.blob())
                .then(blob => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                }));

            // Fetch Instagram Icon
            const instaIcon = await fetch('images/instaLogo.png')
                .then(res => res.blob())
                .then(blob => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                }));

            // YouTube Block
            const ytX = 14;
            doc.addImage(youtubeIcon, 'PNG', ytX, iconY, iconSize, iconSize);
            doc.link(ytX, iconY, iconSize, iconSize, { url: 'https://www.youtube.com/@VimalDeBakers/' });

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.textWithLink('@VimalDeBakers', ytX + iconSize + spacing, iconY + textYOffset, {
                url: 'https://www.youtube.com/@VimalDeBakers/'
            });

            // Instagram Block
            const igX = ytX + iconSize + spacing + doc.getTextWidth('YouTube') + columnGap;
            doc.addImage(instaIcon, 'PNG', igX, iconY, iconSize, iconSize);
            doc.link(igX, iconY, iconSize, iconSize, { url: 'https://www.instagram.com/de.bakers.and.more/' });

            doc.textWithLink('@de.bakers.and.more', igX + iconSize + spacing, iconY + textYOffset, {
                url: 'https://www.instagram.com/de.bakers.and.more/'
            });

            const logo = await fetch('images/billLogo.png')
                .then(res => res.blob())
                .then(blob => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                }));

            doc.addImage(logo, 'PNG', 15, 15, 50, 50);

            doc.setFontSize(25);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(40, 7, 0);
            doc.text("Vekaria Foods", 195, 25, { align: 'right' });
            doc.setFontSize(15);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(107, 68, 0);
            doc.text("De Baker's & More", 195, 32, { align: 'right' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text('GF-30, Shaligram Square,', 195, 42, { align: 'right' });
            doc.text('Nr. Satyamev Vista,', 195, 48, { align: 'right' });
            doc.text('Gota, Ahmedabad - 382481', 195, 54, { align: 'right' });
            const rightX = 195;

            doc.setFont(undefined, 'bold');
            const boldWidth = doc.getTextWidth('Phone: ');

            doc.setFont(undefined, 'normal');
            const number = '+91 9876543210';
            const numberWidth = doc.getTextWidth(number);

            const totalWidth = boldWidth + numberWidth;

            const startX = rightX - totalWidth;

            doc.setFont(undefined, 'bold');
            doc.text('Phone: ', startX, 61);

            doc.setFont(undefined, 'normal');
            doc.text(number, startX + boldWidth, 61);

            let y = 75;

            const billNumber = document.getElementById('billNumber').value;
            const customerName = document.getElementById('customerName').value;
            const customerNumber = document.getElementById('customerNumber').value;
            const billingDateRaw = document.getElementById('billingDate').value;
            const billingDate = new Date(billingDateRaw).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            }).replace(/ /g, '/');
            const billingTimeRaw = document.getElementById('billingTime').value;
            const [hourStr, minute] = billingTimeRaw.split(':');
            const hour = parseInt(hourStr, 10);
            const period = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            const billingTime = `${hour12}:${minute} ${period}`;
            const modeOfDelivery = document.getElementById('modeOfDelivery').value;
            const modeOfPayment = document.getElementById('modeOfPayment').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const overallTotal = document.getElementById('grandTotalCell').textContent;
            const overallDiscount = document.getElementById('overallDiscountInput').value;
            const finalTotal = document.getElementById('finalTotalInput').value;

            doc.setFontSize(11);

            const boxX = 10;
            const boxWidth = 190;
            const contentStartY = y;

            y += 2;

            doc.setFont(undefined, 'bold');
            doc.text('Customer Name:', boxX + 4, y);
            doc.setFont(undefined, 'normal');
            doc.text(customerName || 'N/A', boxX + 37, y);

            doc.setFont(undefined, 'bold');
            doc.text('Contact Number:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(customerNumber || 'N/A', 143, y);

            if (modeOfDelivery === 'Home Delivery') {

                y += 9;

                doc.setFont(undefined, 'bold');
                doc.text(`Address:`, boxX + 4, y);
                doc.setFont(undefined, 'normal');
                doc.text(customerAddress || 'N/A', boxX + 23, y);
            }

            y += 9;

            doc.setFont(undefined, 'bold');
            doc.text(`Bill No:`, boxX + 4, y);
            doc.setFont(undefined, 'normal');
            doc.text(billNumber || 'N/A', boxX + 20, y);

            doc.setFont(undefined, 'bold');
            doc.text('Payment Mode:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(modeOfPayment || 'N/A', 140, y);

            y += 9;

            doc.setFont(undefined, 'bold');
            doc.text('Delivery Mode:', boxX + 4, y);
            doc.setFont(undefined, 'normal');
            doc.text(modeOfDelivery || 'N/A', boxX + 34, y);

            doc.setFont(undefined, 'bold');
            doc.text('Billing Date:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(billingDate || 'N/A', 135, y);

            y += 9;

            doc.setFont(undefined, 'bold');
            doc.text('Billing Date:', boxX + 4, y);
            doc.setFont(undefined, 'normal');
            doc.text(billingTime || 'N/A', boxX + 28, y);

            y += 7;

            const boxHeight = y - contentStartY;

            doc.setDrawColor(0);
            doc.rect(boxX, contentStartY - 6, boxWidth, boxHeight + 4);

            y += 3;

            // Collect product data
            const productRows = [];

            document.querySelectorAll("#productTable tbody tr:not(#noProductRow)").forEach(row => {
                const productName = row.querySelector('.product-name').textContent.trim();
                const productQuantity = row.querySelector('.quantity-input').value;
                const productPrice = row.querySelector('.unit-price').textContent.trim();
                const originalTotal = row.querySelector('.original-total').textContent.trim();
                const productDiscount = row.querySelector('.discount-input').value;
                const productTotal = row.querySelector('.discounted-total-input').value;

                productRows.push([productName, productQuantity, productPrice, originalTotal, productDiscount + '%', productTotal]);
            });

            // Draw the table
            let currentY = y;
            const firstPageRows = 15;
            const nextPageRows = 25;

            const totalRows = productRows.length;

            // Split productRows into paginated chunks
            const paginatedRows = [];

            if (totalRows <= firstPageRows) {
                paginatedRows.push(productRows);
            } else {
                paginatedRows.push(productRows.slice(0, firstPageRows));
                for (let i = firstPageRows; i < totalRows; i += nextPageRows) {
                    paginatedRows.push(productRows.slice(i, i + nextPageRows));
                }
            }

            paginatedRows.forEach((rowsChunk, index) => {
                const isFirstPage = index === 0;
                const isLastPage = index === paginatedRows.length - 1;

                doc.autoTable({
                    startY: currentY,
                    head: [[
                        'Product Name',
                        'Quantity',
                        'Price (per unit)',
                        'Total',
                        'Discount (%)',
                        'Discounted Total',
                    ]],
                    body: rowsChunk,
                    foot: isLastPage ? [
                        [
                            { content: 'Overall Total:', colSpan: 5 },
                            { content: "Rs. " + overallTotal }
                        ],
                        [
                            { content: 'Overall Discount:', colSpan: 5 },
                            { content: overallDiscount + " %" }
                        ],
                        [
                            { content: 'Final Total:', colSpan: 5 },
                            { content: "Rs. " + finalTotal }
                        ]
                    ] : undefined,
                    styles: {
                        fontSize: 10,
                        lineColor: [0, 0, 0],
                        lineWidth: 0.1,
                        textColor: "#000000",
                    },
                    headStyles: {
                        fillColor: [240, 240, 240],
                        textColor: "#000000",
                    },
                    footStyles: {
                        fillColor: [240, 240, 240],
                        textColor: "#000000",
                    },
                    margin: {
                        left: 10,
                        right: 10,
                    },
                    theme: 'grid',
                });

                // If not the last page, add a new one and reset Y
                if (!isLastPage) {
                    doc.addPage();
                    currentY = 20;
                } else {
                    currentY = doc.lastAutoTable.finalY + 8;
                }
            });

            currentY = doc.lastAutoTable.finalY + 8;

            // Generate and add UPI QR code
            const upiId = "Q355693476@ybl";
            const payeeName = "PhonePeMerchant";
            const upiAmount = finalTotal;

            const qrBase64 = await generateUpiQrBase64(upiId, payeeName, upiAmount);

            const pageHeight = doc.internal.pageSize.getHeight();

            // Ensure space for QR code
            if (currentY + 60 > pageHeight) {
                doc.addPage();
                currentY = 20;
            }

            let qrTextBox = currentY + 6;

            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(40, 7, 0);
            doc.text("Scan & Pay", leftMargin, qrTextBox);

            let x = leftMargin;
            qrTextBox = qrTextBox + 8;

            const part1 = "OR Pay Directly on ";
            const phone = "+91 9879718228";
            const part2 = " or on UPI ID : ";
            const upi = "Q355693476@ybl";

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(part1, x, qrTextBox);

            x += doc.getTextWidth(part1);

            doc.setFont(undefined, 'bold');
            doc.text(phone, x, qrTextBox);
            x += doc.getTextWidth(phone);

            doc.setFont(undefined, 'normal');
            doc.text(part2, x, qrTextBox);
            x += doc.getTextWidth(part2);

            doc.setFont(undefined, 'bold');
            doc.text(upi, x, qrTextBox);

            qrTextBox = qrTextBox + 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text("Kindly share the payment confirmation screenshot once the payment is completed,", leftMargin, qrTextBox);

            qrTextBox = qrTextBox + 6;

            doc.text("so we can proceed with processing your order.", leftMargin, qrTextBox);

            doc.addImage(qrBase64, 'PNG', 160, currentY, 40, 40);

            async function generateUpiQrBase64(upiId, payeeName, amount) {
                const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR`;

                return new Promise((resolve) => {
                    const tempDiv = document.createElement("div");
                    const qr = new QRCode(tempDiv, {
                        text: upiUrl,
                        width: 150,
                        height: 150,
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    setTimeout(() => {
                        const img = tempDiv.querySelector('img');
                        resolve(img.src);
                    }, 500);
                });
            }

            const pageCount = doc.getNumberOfPages();

            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.setFont(undefined, 'bold');
                doc.text("This is a computer-generated bill and does not require any signature or stamp.", 105, 283, { align: 'center' });
                doc.text("In case of any query, contact +91 9879718228", 105, 290, { align: 'center' });
            }

            // Development

            // const pdfBlob = doc.output('blob');
            // const blobUrl = URL.createObjectURL(pdfBlob);
            // document.getElementById('pdfIframe').src = blobUrl;

            // Save PDF

            const pad = n => n.toString().padStart(2, '0');
            const billingDateObj = new Date(billingDateRaw);
            const day = pad(billingDateObj.getDate());
            const month = pad(billingDateObj.getMonth() + 1);
            const year = billingDateObj.getFullYear();

            const hourPadded = pad(hour);
            const minutePadded = pad(minute);

            const formattedDateTime = `${day}${month}${year}${hourPadded}${minutePadded}`;

            const filenameParts = [
                billNumber || '00',
                (customerName || 'Unknown').replace(/\s+/g, '_'),
                formattedDateTime
            ];
            const suggestedName = filenameParts.join('_') + '.pdf';

            const fileHandle = await window.showSaveFilePicker({
                suggestedName,
                types: [{
                    description: 'PDF Files',
                    accept: { 'application/pdf': ['.pdf'] },
                }],
            });
            const writableStream = await fileHandle.createWritable();
            await writableStream.write(doc.output('blob'));
            await writableStream.close();

        });

    </script>
</body>

</html>